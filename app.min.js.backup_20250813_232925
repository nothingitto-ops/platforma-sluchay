// –û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ products.json: 2025-08-13 23:17:05
const DEFAULT_TG = 'https://t.me/stub123';
/* ===== DATA (–≥–ª–∞–≤–Ω–∞—è) ===== */
const items = [
  {
    "images": [
      "product_2/product_2_1.jpg",
      "product_2/product_2_2.jpg",
      "product_2/product_2_3.jpg",
      "product_2/product_2_4.jpg"
    ],
    "title": "–ü–æ—è—Å-—é–±–∫–∞",
    "price": "3002 —Ä.",
    "desc": "–ü–æ—è—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –º–µ—à–∫–∞",
    "meta": "–°–æ—Å—Ç–∞–≤: 50% —Ö–ª–æ–ø–æ–∫ 50% –ª—ë–Ω",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 1,
    "section": "home"
  },
  {
    "images": [
      "product_1/product_1_1.jpg",
      "product_1/product_1_2.jpg",
      "product_1/product_1_3.jpg",
      "product_1/product_1_4.jpg"
    ],
    "title": "–ü–æ—è—Å —Ü–≤–µ—Ç–æ—á–Ω—ã–π",
    "price": "3000 —Ä.",
    "desc": "–ü–æ—è—Å, —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å nessffo, —Ä–∏—Å—É–Ω–æ–∫ –ø—Ä–∏ –ø–æ–º–æ—â–∏ —Ü–∏–∞–Ω–æ—Ç–∏–ø–∏–∏",
    "meta": "–°–æ—Å—Ç–∞–≤: 50% —Ö–ª–æ–ø–æ–∫ 50% –ª—ë–Ω",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 1,
    "section": "nessffo"
  },
  {
    "images": [
      "product_3/product_3_1.jpg",
      "product_3/product_3_2.jpg",
      "product_3/product_3_3.jpg",
      "product_3/product_3_4.jpg"
    ],
    "title": "–ü–æ—è—Å P1",
    "price": "3500 —Ä.",
    "desc": "–ü–æ—è—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –º–µ—à–∫–∞",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 2,
    "section": "home"
  },
  {
    "images": [
      "product_7/product_7_1.jpg",
      "product_7/product_7_2.jpg",
      "product_7/product_7_3.jpg",
      "product_7/product_7_4.jpg"
    ],
    "title": "–°—É–º–∫–∞ —á–µ—Ä–µ–∑ –ø–ª–µ—á–æ",
    "price": "4500 —Ä.",
    "desc": "–°—É–º–∫–∞, —Å–æ–∑–¥–∞–Ω–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å nessffo, —Ä–∏—Å—É–Ω–æ–∫ –ø—Ä–∏ –ø–æ–º–æ—â–∏ —Ü–∏–∞–Ω–æ—Ç–∏–ø–∏–∏",
    "meta": "–°–æ—Å—Ç–∞–≤: 50% —Ö–ª–æ–ø–æ–∫ 50% –ª—ë–Ω",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 2,
    "section": "nessffo"
  },
  {
    "images": [
      "product_4/product_4_1.jpg",
      "product_4/product_4_2.jpg",
      "product_4/product_4_3.jpg",
      "product_4/product_4_4.jpg",
      "product_4/product_4_5.jpg",
      "product_4/product_4_6.jpg"
    ],
    "title": "–†—É–±–∞—à–∫–∞",
    "price": "4000 —Ä.",
    "desc": "–õ—ë–≥–∫–∞—è —Ä—É–±–∞—à–∫–∞ —Å–æ —Å–≤–æ–±–æ–¥–Ω—ã–º–∏ —Ä—É–∫–∞–≤–∞–º–∏",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 3,
    "section": "home"
  },
  {
    "images": [
      "product_5/product_5_1.jpg",
      "product_5/product_5_2.jpg",
      "product_5/product_5_3.jpg",
      "product_5/product_5_4.jpg",
      "product_5/product_5_5.jpg"
    ],
    "title": "–®—Ç–∞–Ω—ã —Å –ø–æ—è—Å–æ–º U2",
    "price": "5800 —Ä.",
    "desc": "–°–≤–æ–±–æ–¥–Ω—ã–µ —à—Ç–∞–Ω—ã —Å —É–∫–æ—Ä–æ—á–µ–Ω–Ω—ã–º –ø–æ—è—Å–æ–º-—é–±–∫–æ–π",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 4,
    "section": "home"
  },
  {
    "images": [
      "product_6/product_6_1.jpg",
      "product_6/product_6_2.jpg",
      "product_6/product_6_3.jpg",
      "product_6/product_6_4.jpg",
      "product_6/product_6_5.jpg",
      "product_6/product_6_6.jpg"
    ],
    "title": "–†—É–±–∞—à–∫–∞ —Å –≤—ã—à–∏–≤–∫–æ–π",
    "price": "8000 —Ä.",
    "desc": "–†—É–±–∞—à–∫–∞ —Å –≤—ã—à–∏–≤–∫–æ–π",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% —Ö–ª–æ–ø–æ–∫ ¬∑ –î–µ–ª–∏–∫–∞—Ç–Ω–∞—è —Å—Ç–∏—Ä–∫–∞ 30¬∞C, –ø–æ—Å–ª–µ —Å—Ç–∏—Ä–∫–∏ —Ä—É–±–∞—à–∫–∞ –º–æ–∂–µ—Ç –æ–±—Ä–µ—Å—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç –≤–∞—Ä—ë–Ω–æ–π —Ç–∫–∞–Ω–∏",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 5,
    "section": "home"
  },
  {
    "images": [
      "product_8/product_8_1.jpg",
      "product_8/product_8_2.jpg",
      "product_8/product_8_3.jpg",
      "product_8/product_8_4.jpg"
    ],
    "title": "–†—É–±–∞—à–∫–∞ –∏ —à–æ—Ä—Ç—ã",
    "price": "7500 —Ä.",
    "desc": "–†—É–±–∞—à–∫–∞ –∏ —à–æ—Ä—Ç—ã",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 6,
    "section": "home"
  },
  {
    "images": [
      "product_9/product_9_1.jpg",
      "product_9/product_9_2.jpg",
      "product_9/product_9_3.jpg"
    ],
    "title": "–ü–ª–∞—Ç–æ–∫ –Ω–∞ —à–µ—é",
    "price": "1000 —Ä.",
    "desc": "–ü–ª–∞—Ç–æ–∫ —Å–µ—Ä–æ–≥–æ —Ü–≤–µ—Ç–∞",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –∂–∞—Ç–∞—è –≤–∏—Å–∫–æ–∑–∞ ¬∑ –î–µ–ª–∏–∫–∞—Ç–Ω–∞—è —Å—Ç–∏—Ä–∫–∞ 30¬∞C",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 7,
    "section": "home"
  },
  {
    "images": [
      "product_10/product_10_1.jpg",
      "product_10/product_10_2.jpg",
      "product_10/product_10_3.jpg"
    ],
    "title": "–®—Ç–∞–Ω—ã —Å –ø–æ—è—Å–æ–º U1",
    "price": "6000 —Ä.",
    "desc": "–°–≤–æ–±–æ–¥–Ω—ã–µ —à—Ç–∞–Ω—ã —Å –ø–æ—è—Å–æ–º-—é–±–∫–æ–π",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 8,
    "section": "home"
  },
  {
    "images": [
      "product_11/product_11_1.jpg",
      "product_11/product_11_2.jpg",
      "product_11/product_11_3.jpg",
      "product_11/product_11_4.jpg"
    ],
    "title": "–§–∞—Ä—Ç—É–∫",
    "price": "3000 —Ä.",
    "desc": "–§–∞—Ä—Ç—É–∫ –∏–º–µ–µ—Ç –∫–∞—Ä–º–∞–Ω –∏ –±—Ä–µ—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –¥–ª–∏–Ω—É –ø—Ä–∏ –ø–æ–º–æ—â–∏ –ø—É–≥–æ–≤–∏—Ü—ã",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 9,
    "section": "home"
  },
  {
    "images": [
      "product_12/product_12_1.jpg",
      "product_12/product_12_2.jpg",
      "product_12/product_12_3.jpg",
      "product_12/product_12_4.jpg"
    ],
    "title": "–ü–ª–∞—Ç–æ–∫ –Ω–∞ —à–µ—é",
    "price": "1000 —Ä.",
    "desc": "–ü–ª–∞—Ç–æ–∫ –º–æ–ª–æ—á–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –∂–∞—Ç–∞—è –≤–∏—Å–∫–æ–∑–∞ ¬∑ –î–µ–ª–∏–∫–∞—Ç–Ω–∞—è —Å—Ç–∏—Ä–∫–∞ 30¬∞C",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 10,
    "section": "home"
  }
]; // –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞

/* ===== GRID (–ø–µ—Ä–≤–∏—á–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥–ª–∞–≤–Ω–æ–π ‚Äî –û–°–¢–ê–í–õ–ï–ù–û –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ===== */
const $catalog=document.getElementById('catalog');
const __initialTab = (location.hash.replace('#','')==='nessffo') ? 'nessffo' : 'home';
const ENABLE_INITIAL_HOME_RENDER = false; // –æ—Ç–∫–ª—é—á–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –º–∏–≥–∞–ª–∞ –Ω–µ—Ü–µ–ª–µ–≤–æ–π —Ä–∞–∑–¥–µ–ª
if(ENABLE_INITIAL_HOME_RENDER && __initialTab==='home'){
  items.forEach(it=>{
    const card=document.createElement('div');
    card.className='card'+(it.placeholder?' placeholder':'');
    const imgBox=document.createElement('div');imgBox.className='card-img';
    const img=document.createElement('img');
    const _hints = folderHintsFromFirst((it.images && it.images[0])||'');
    setSrcWithFallback(img, (it.images&&it.images[0])||'img/item-placeholder.jpg', _hints);
    img.alt=it.title||''; img.draggable=false;
    img.addEventListener('dragstart', e=>e.preventDefault());
    imgBox.appendChild(img);
    card.appendChild(imgBox);
    const h3=document.createElement('h3');h3.textContent=it.title||'';card.appendChild(h3);
    const price=document.createElement('div');price.className='price';price.textContent=it.price||'';card.appendChild(price);
    if(!it.placeholder && it.status){ const st=document.createElement('div'); const cls=(it.status==='preorder')?'pre':'in'; st.className='status '+cls; st.textContent=(it.status==='preorder')?'–ø–æ–¥ –∑–∞–∫–∞–∑':'–≤ –Ω–∞–ª–∏—á–∏–∏'; card.appendChild(st);} 
    $catalog.appendChild(card);
    if(!it.placeholder) card.addEventListener('click',()=>openModal(it, currentTab));
  });
}

/* ===== MOD–ê–õ–ö–ê ===== */
const $modal=document.getElementById('modal');
const $viewer=document.getElementById('viewer');
const $viewerImg=document.getElementById('viewerImg');
const $thumbs=document.getElementById('thumbs');
const $zoomBtn=document.getElementById('zoomBtn');
const $mTitle=document.getElementById('mTitle');
const $mPrice=document.getElementById('mPrice');
const $mDesc=document.getElementById('mDesc');
const $mMeta=document.getElementById('mMeta');


const $carePanel=document.getElementById('carePanel');
const $mStatus=document.getElementById('mStatus');
const $mLink=document.getElementById('mLink');
const $hero=document.querySelector('.hero');
if ($hero) {
  $hero.setAttribute('decoding','async');
  $hero.setAttribute('loading','eager');
  $hero.setAttribute('fetchpriority','high');
}
const $topnav=document.querySelector('.topnav');

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–≤–∞–π–ø–æ–≤
let touchStartY = 0;
let touchStartX = 0;
let touchEndY = 0;
let touchEndX = 0;
let isSwiping = false;
let swipeThreshold = 100;
let isSwipeUp = false;
let sheetElement = null; // –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–≤–∞–π–ø–∞

function applyNavScroll(){ 
  if($topnav) {
    if(window.scrollY>8) $topnav.classList.add('scrolled'); 
    else $topnav.classList.remove('scrolled'); 
  }
}
window.addEventListener('scroll', applyNavScroll, {passive:true});
applyNavScroll();

const SHEET_TSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGdW7QcHV6BgZHJnSMzXKkmsXDYZulMojN312tgvI6PK86H8dRjReYUOHI2l_aVYzLg2NIjAcir89g/pub?output=tsv&t=20250810191426&v=20250810191426&nocache=1'; // ‚Üê –≤–∞—à–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ Google Sheets

let current=null,curIndex=0,zoomed=false, currentHints=[];
let dragging=false, startX=0, startY=0, tx=0, ty=0, moved=false;   // translate state
const SCALE=2; // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑—É–º–∞
const DRAG_THRESHOLD = 3; // px ‚Äî —á—Ç–æ–±—ã –∫–ª–∏–∫ –Ω–µ –ø—É—Ç–∞–ª—Å—è —Å –º–∏–∫—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è–º–∏

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
let currentTab = (location.hash.replace('#','')==='nessffo') ? 'nessffo' : 'home';
let activeFilter = 'all';
let heroReady = false;

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–≤–∞–π–ø–æ–≤
function handleTouchStart(e) {
  if (e.touches.length === 1) {
    touchStartY = e.touches[0].clientY;
    touchStartX = e.touches[0].clientX;
    isSwiping = false;
  }
}

function handleTouchMove(e) {
  if (e.touches.length === 1 && !zoomed) {
    touchEndY = e.touches[0].clientY;
    touchEndX = e.touches[0].clientX;
    
    const deltaY = touchStartY - touchEndY;
    const deltaX = touchStartX - touchEndX;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Å–≤–∞–π–ø (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∏–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π)
    if (Math.abs(deltaY) > 5 || Math.abs(deltaX) > 5) {
      isSwiping = true;
      
      // –î–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–≤–∞–π–ø–∞ –≤–≤–µ—Ä—Ö –¥–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
      if (Math.abs(deltaY) > Math.abs(deltaX) && deltaY > 0) {
        isSwipeUp = true;
        e.preventDefault();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —É–±–∏—Ä–∞–Ω–∏—è —Ç–µ–º–Ω–æ–≥–æ —Ñ–µ–π–¥–∞ —Å—Ä–∞–∑—É
        $modal.classList.add('swiping');
        
        // –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞ –ø–∞–ª—å—Ü–µ–º
        if (sheetElement) {
          // –ë–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ - –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–≤–∏–∂–µ—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ
          const resistance = 0.8; // 80% –æ—Ç –¥–≤–∏–∂–µ–Ω–∏—è –ø–∞–ª—å—Ü–∞
          const maxSwipe = window.innerHeight * 0.8; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø 80% –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
          const translateY = Math.min((deltaY * resistance), maxSwipe);
          const translatePercent = (translateY / maxSwipe) * 100;
          
          sheetElement.style.transform = `translateY(-${translatePercent}%)`;
          sheetElement.style.transition = 'none'; // –ë–µ–∑ transition –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞ –ø–∞–ª—å—Ü–µ–º
        }
      } else {
        isSwipeUp = false;
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö —Å–≤–∞–π–ø–æ–≤
        if (Math.abs(deltaY) > Math.abs(deltaX)) {
          e.preventDefault();
        }
      }
    }
  }
}

function handleTouchEnd(e) {
  if (isSwiping && !zoomed && current) {
    const deltaY = touchStartY - touchEndY;
    const deltaX = touchStartX - touchEndX;
    
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å swiping
    $modal.classList.remove('swiping');
    
    // –°–≤–∞–π–ø –≤–≤–µ—Ä—Ö –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ - –ø–æ—Ä–æ–≥ 35% –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
    const screenHeight = window.innerHeight;
    const threshold = screenHeight * 0.35; // 35% –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    
    if (deltaY > threshold && Math.abs(deltaY) > Math.abs(deltaX)) {
      // –ü–ª–∞–≤–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
      if (sheetElement) {
        $modal.classList.add('swipe-complete'); // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º —Ñ–µ–π–¥
        sheetElement.classList.add('swipe-complete');
        sheetElement.style.transform = 'translateY(-100%)';
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
          closeModal();
        }, 600);
      } else {
        closeModal();
      }
    } else if (isSwipeUp) {
      // –ï—Å–ª–∏ —Å–≤–∞–π–ø –Ω–µ –¥–æ—Å—Ç–∏–≥ –ø–æ—Ä–æ–≥–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–¥–∞–ª–∫—É –Ω–∞ –º–µ—Å—Ç–æ –ø–ª–∞–≤–Ω–æ
      if (sheetElement) {
        sheetElement.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        sheetElement.style.transform = 'translateY(0)';
        
        // –£–±–∏—Ä–∞–µ–º transition –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
          sheetElement.style.transition = 'none';
        }, 300);
      }
    }
    // –°–≤–∞–π–ø –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –¥–ª—è –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ
    else if (Math.abs(deltaX) > swipeThreshold && current.images.length > 1) {
      if (deltaX > 0) {
        // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ
        curIndex = (curIndex + 1) % current.images.length;
      } else {
        // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ
        curIndex = (curIndex - 1 + current.images.length) % current.images.length;
      }
      setMain(current.images[curIndex], true);
    }
  }
  
  isSwiping = false;
  isSwipeUp = false;
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤ –∫ –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É
function addSwipeHandlers() {
  const $sheet = document.querySelector('.modal .sheet');
  if ($sheet) {
    sheetElement = $sheet; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç
    $sheet.addEventListener('touchstart', handleTouchStart, { passive: false });
    $sheet.addEventListener('touchmove', handleTouchMove, { passive: false });
    $sheet.addEventListener('touchend', handleTouchEnd, { passive: true });
  }
}

// –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤
function removeSwipeHandlers() {
  const $sheet = document.querySelector('.modal .sheet');
  if ($sheet) {
    $sheet.removeEventListener('touchstart', handleTouchStart);
    $sheet.removeEventListener('touchmove', handleTouchMove);
    $sheet.removeEventListener('touchend', handleTouchEnd);
  }
}

function openModal(item, section){
  current=item;curIndex=0;zoomed=false;tx=ty=0;currentHints=folderHintsFromFirst(item.images[0]);
  $mTitle.textContent=item.title;
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É: —É–±–∏—Ä–∞–µ–º " —Ä." –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã + —Å–∏–º–≤–æ–ª ‚ÇΩ
  const priceText = item.price.replace(' —Ä.', '').replace('—Ä', '');
  const formattedPrice = priceText.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ‚ÇΩ';
  
  // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–µ–Ω—ã –∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  $mPrice.innerHTML = '';
  const priceContainer = document.createElement('div');
  priceContainer.className = 'modal-price-container';
  
  const priceElement = document.createElement('span');
  priceElement.className = 'price-text';
  priceElement.textContent = formattedPrice;
  priceContainer.appendChild(priceElement);
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–ø—Ä–∞–≤–∞ –æ—Ç —Ü–µ–Ω—ã
  if (item.status) {
    const statusElement = document.createElement('span');
    const cls = (item.status === 'preorder') ? 'pre' : 'in';
    statusElement.className = 'modal-status ' + cls;
    statusElement.textContent = (item.status === 'preorder') ? '–ø–æ–¥ –∑–∞–∫–∞–∑' : '–≤ –Ω–∞–ª–∏—á–∏–∏';
    priceContainer.appendChild(statusElement);
  }
  
  $mPrice.appendChild(priceContainer);
  
  $mDesc.textContent=item.desc;
  
  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ 4 —Å—Ç—Ä–æ–∫–∞–º–∏ –∏ —É–±–∏—Ä–∞–µ–º —Å–∫—Ä–æ–ª–ª
  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è 4 —Å—Ç—Ä–æ–∫
  $mDesc.style.setProperty('-webkit-line-clamp', '4', 'important');
  $mDesc.style.setProperty('height', '6em', 'important');
  $mDesc.style.setProperty('max-height', '6em', 'important');
  $mMeta.textContent=item.meta||'';
  $mLink.href=item.link;
  // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –æ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å —Ü–µ–Ω–æ–π
  $mStatus.style.display='none';
  setMain(item.images[0], true);
  renderThumbs(item.images);
  leaveZoom();
  $modal.classList.add('open');
  document.body.style.overflow='hidden';
  addSwipeHandlers(); // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
}
function closeModal(){
  // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã –∞–Ω–∏–º–∞—Ü–∏–∏
  $modal.classList.remove('open', 'swipe-complete', 'swiping');
  document.body.style.overflow='';
  leaveZoom();
  removeSwipeHandlers(); // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
  if (sheetElement) {
    sheetElement.style.transform = '';
    sheetElement.style.transition = 'none';
    sheetElement.classList.remove('swipe-complete', 'wobble');
  }
  
  // –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
  const dots = document.querySelector('.image-dots');
  if (dots) dots.remove();
}
if($modal) $modal.addEventListener('click',closeModal);
const closeBtn = document.getElementById('closeBtn');
if(closeBtn) closeBtn.addEventListener('click',closeModal);

function renderThumbs(arr){
  $thumbs.innerHTML='';
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  if (window.innerWidth <= 768 && arr.length > 1) {
    const dotsContainer = document.createElement('div');
    dotsContainer.className = 'image-dots';
    arr.forEach((_, idx) => {
      const dot = document.createElement('div');
      dot.className = `image-dot ${idx === curIndex ? 'active' : ''}`;
      dotsContainer.appendChild(dot);
    });
    $viewer.appendChild(dotsContainer);
  }
  
  arr.forEach((src,i)=>{
    const t=document.createElement('img');
    setSrcWithFallback(t, src, currentHints); t.alt='';
    t.draggable=false;
    t.addEventListener('dragstart', e=>e.preventDefault());
    if(i===curIndex)t.classList.add('active');
    t.onclick=()=>{
      curIndex=i;
      setMain(src, true);
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏
      document.querySelectorAll('.image-dot').forEach((dot, idx) => {
        dot.classList.toggle('active', idx === i);
      });
    };
    $thumbs.appendChild(t);
  });
}

/* === –ú–ì–ù–û–í–ï–ù–ù–ê–Ø —Å–º–µ–Ω–∞ –∫–∞–¥—Ä–∞, –±–µ–∑ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ === */
function setMain(src, snap=false){
  if(!$viewerImg || !$thumbs) return;
  leaveZoom();                 // —Å–±—Ä–æ—Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π
  if (snap) $viewerImg.style.transition = 'none'; // –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
  setSrcWithFallback($viewerImg, src, currentHints);
  // –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–µ–≤—å—é
  [...$thumbs.children].forEach((el,i)=>el.classList.toggle('active',i===curIndex));
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
  document.querySelectorAll('.image-dot').forEach((dot, idx) => {
    dot.classList.toggle('active', idx === curIndex);
  });
}

/* –õ–∏—Å—Ç–∞–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É –ø–æ –∫—Ä–∞—è–º ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ù–ï –∑—É–º */
if($viewer) {
  $viewer.addEventListener('click',e=>{
    if(zoomed || moved) return; // –≤ –∑—É–º–µ –∫–ª–∏–∫–∏ –∏–≥–Ω–æ—Ä–∏–º, –∞ –µ—Å–ª–∏ –±—ã–ª –¥—Ä–∞–≥ ‚Äî —Ç–æ–∂–µ
    const rect=$viewer.getBoundingClientRect();
    const left=(e.clientX-rect.left) < rect.width/2;
    curIndex=(curIndex+(left?-1:1)+current.images.length)%current.images.length;
    setMain(current.images[curIndex], true);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∫—Ä–∞—è–º
    document.querySelectorAll('.image-dot').forEach((dot, idx) => {
      dot.classList.toggle('active', idx === curIndex);
    });
  });
}

/* === –ó–£–ú ===
   ‚Äî –ö–Ω–æ–ø–∫–∞ üîç: –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç
   ‚Äî –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é: –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç
   ‚Äî –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ, –±–µ–∑ ¬´wobbling¬ª –∏ –±–µ–∑ drag ghost
*/
if($zoomBtn) $zoomBtn.addEventListener('click',()=> zoomed ? leaveZoom() : enterZoom());
if($viewerImg) {
  $viewerImg.addEventListener('dblclick', (e)=>{
    e.preventDefault();
    e.stopPropagation();
    if(zoomed) leaveZoom(); // –≤—Ö–æ–¥ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É; dblclick ‚Äî —Ç–æ–ª—å–∫–æ –≤—ã—Ö–æ–¥
  });
}

function enterZoom(){
  if(!$viewerImg) return;
  zoomed=true;tx=ty=0;
  $viewerImg.style.transition='none';
  $viewerImg.style.transform=`translate(0px,0px) scale(${SCALE})`;
  $viewerImg.style.cursor='grab';
}
function leaveZoom(){
  if(!$viewerImg) return;
  zoomed=false;dragging=false;tx=ty=0;
  $viewerImg.style.transition='none';
  $viewerImg.style.transform='translate(0px,0px) scale(1)';
  $viewerImg.style.cursor='default';
}

/* ‚Äî‚Äî‚Äî –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Pointer Events (—á—Ç–æ–± –±–µ–∑ ghost-–∏–∫–æ–Ω–æ–∫) ‚Äî‚Äî‚Äî */
if($viewerImg) {
  $viewerImg.addEventListener('dragstart', e=>e.preventDefault());

  $viewerImg.addEventListener('pointerdown', e=>{
    if(!zoomed) return;
    e.preventDefault(); // –Ω–µ –¥–∞—ë–º –±—Ä–∞—É–∑–µ—Ä—É –Ω–∞—á–∏–Ω–∞—Ç—å drag-image
    $viewerImg.setPointerCapture(e.pointerId);
    dragging=true; moved=false;
    startX=e.clientX; startY=e.clientY;
    $viewerImg.style.cursor='grabbing';
  });

  $viewerImg.addEventListener('pointermove', e=>{
    if(!zoomed || !dragging) return;
    const dx=e.clientX-startX, dy=e.clientY-startY;
    if (!moved && (Math.abs(dx)>DRAG_THRESHOLD || Math.abs(dy)>DRAG_THRESHOLD)) moved=true;

    const nextX=tx+dx, nextY=ty+dy;
    const bounds=getBounds();
    const clampedX=Math.max(bounds.minX, Math.min(bounds.maxX, nextX));
    const clampedY=Math.max(bounds.minY, Math.min(bounds.maxY, nextY));
    $viewerImg.style.transform=`translate(${clampedX}px,${clampedY}px) scale(${SCALE})`;
  });

  $viewerImg.addEventListener('pointerup', e=>{
    if(!zoomed) return;
    $viewerImg.releasePointerCapture(e.pointerId);
    dragging=false;
    // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–º–µ—â–µ–Ω–∏–µ –∏–∑ transform:
    const m = /translate\(([-\d.]+)px,\s*([-\d.]+)px\)/.exec($viewerImg.style.transform);
    if(m){ tx=parseFloat(m[1]); ty=parseFloat(m[2]); }
    $viewerImg.style.cursor='grab';
  });
}

/* –ì—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–µ—Ä–µ—Ç—è–≥–∏–≤–∞–Ω–∏—è –≤ –∑—É–º–µ */
function getBounds(){
  if(!$viewerImg || !$viewer) return {minX:0, maxX:0, minY:0, maxY:0};
  const iw=$viewerImg.naturalWidth, ih=$viewerImg.naturalHeight;
  const cw=$viewer.clientWidth, ch=$viewer.clientHeight;
  // —Ä–∞–∑–º–µ—Ä—ã –≤–ø–∏—Å–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø—Ä–∏ scale=1
  const imgAspect=iw/ih, boxAspect=cw/ch;
  let fittedW, fittedH;
  if(imgAspect>boxAspect){ fittedW=cw; fittedH=cw/imgAspect; }
  else { fittedH=ch; fittedW=ch*imgAspect; }

  const zw = fittedW * SCALE;
  const zh = fittedH * SCALE;
  const maxX = Math.max(0, (zw - cw)/2);
  const maxY = Math.max(0, (zh - ch)/2);
  return {minX:-maxX, maxX, minY:-maxY, maxY};
}

window.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });

// –ö—ç—à –¥–ª—è —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—É—Ç–µ–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
const RESOLVED_SRC = Object.create(null);

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø—É—Ç–µ–π —Å —É—á—ë—Ç–æ–º –≤–æ–∑–º–æ–∂–Ω–æ–π –ø–æ–¥–ø–∞–ø–∫–∏
function folderHintsFromFirst(first){
  if(!first) return [];
  let s = String(first).trim();
  const low = s.toLowerCase();
  // –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä —è–≤–Ω–æ —É–∫–∞–∑–∞–ª –ø–æ–¥–ø—É—Ç—å "folder/file.jpg" ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ —Ö–∏–Ω—Ç
  if (s.includes('/')) {
    const dir = s.split('/')[0].replace(/^\.\/?|^img\//,'');
    return [dir];
  }
  // –∏–Ω–∞—á–µ —Å—Ç—Ä–æ–∏–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏–∑ –∏–º–µ–Ω–∏ –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞
  if (low.startsWith('img/')) s = s.slice(4);
  const dot = s.lastIndexOf('.');
  const base = dot > 0 ? s.slice(0, dot) : s; // –Ω–∞–ø—Ä. shawl-1
  const lastDash = base.lastIndexOf('-');
  const prefix   = lastDash > 0 ? base.slice(0, lastDash) : base; // shawl
  // –≤—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–∏—Å –ø–µ—Ä–µ–¥ —Ö–≤–æ—Å—Ç–æ–≤—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ –±—ã–ª–æ (apron1 -> apron-1)
  let dashedPrefix = prefix;
  let i = prefix.length - 1;
  while (i >= 0) { const code = prefix.charCodeAt(i); if (code < 48 || code > 57) break; i--; }
  if (i < prefix.length - 1 && prefix[i] !== '-') {
    dashedPrefix = prefix.slice(0, i + 1) + '-' + prefix.slice(i + 1);
  }
  return Array.from(new Set([dashedPrefix, prefix, base].filter(Boolean)));
}

// –î–µ–ª–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—É—Ç–∏ –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤—ã–π —É–¥–∞—á–Ω—ã–π.
function candidatesFor(src, hintFolders){
  if(!src) return ['img/item-placeholder.jpg'];
  let s = String(src);
  const low = s.toLowerCase();
  // –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ URL ‚Äî –∫–∞–∫ –µ—Å—Ç—å
  if (low.startsWith('http://') || low.startsWith('https://')) return [s];
  // —É–±—Ä–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å img/
  if (low.startsWith('img/')) s = s.slice(4);
  else if (low.startsWith('./img/')) s = s.slice(6);
  else if (low.startsWith('/img/')) s = s.slice(5);
  // –µ—Å–ª–∏ —É–∂–µ —É–∫–∞–∑–∞–Ω –ø–æ–¥–ø—É—Ç—å –≤–∏–¥–∞ folder/file.jpg ‚Äî –ø—Ä–æ–±—É–µ–º –∫–∞–∫ –µ—Å—Ç—å (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º img/)
  if (s.includes('/')) return ['img/' + s];

  // –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
  const dot = s.lastIndexOf('.');
  const base = dot > 0 ? s.slice(0, dot) : s;            // –Ω–∞–ø—Ä. apron1-1
  const lastDash = base.lastIndexOf('-');
  const prefix   = lastDash > 0 ? base.slice(0, lastDash) : base; // –Ω–∞–ø—Ä. apron1

  // –¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–∏—Å –ø–µ—Ä–µ–¥ —Ö–≤–æ—Å—Ç–æ–≤—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏: apron1 -> apron-1
  let dashedPrefix = prefix;
  let i = prefix.length - 1;
  while (i >= 0) { const code = prefix.charCodeAt(i); if (code < 48 || code > 57) break; i--; }
  if (i < prefix.length - 1 && prefix[i] !== '-') {
    dashedPrefix = prefix.slice(0, i + 1) + '-' + prefix.slice(i + 1);
  }

  // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–¥–ø–∞–ø–æ–∫: —Å–Ω–∞—á–∞–ª–∞ –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–µ (shawl-2 —Ä–∞–Ω—å—à–µ shawl-2-1)
  const hints = Array.isArray(hintFolders)
    ? Array.from(new Set(hintFolders)).sort((a,b)=>{
        const ad = a.includes('-'), bd = b.includes('-');
        if(ad && !bd) return -1; // –ø–∞–ø–∫–∏ —Å –¥–µ—Ñ–∏—Å–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ
        if(bd && !ad) return 1;
        return a.length - b.length; // –∑–∞—Ç–µ–º –ø–æ –¥–ª–∏–Ω–µ ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ —Ä–∞–Ω—å—à–µ
      })
    : [];

  const list = [
    // 0) –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –ø–∞–ø–∫–∏ –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–æ—Ç –∫–æ—Ä–æ—Ç–∫–∏—Ö –∫ –¥–ª–∏–Ω–Ω—ã–º)
    ...hints.map(h => `img/${h}/${s}`),
    // 1) –ø–∞–ø–∫–∞ = —á–∞—Å—Ç—å –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ—Ñ–∏—Å–∞ (belt-skirt-1/belt-skirt-1-1.jpg)
    `img/${prefix}/${s}`,
    // 2) —á–∞—Å—Ç—å + –¥–µ—Ñ–∏—Å –ø–µ—Ä–µ–¥ —Ü–∏—Ñ—Ä–∞–º–∏ (apron-1/apron1-1.jpg)
    `img/${dashedPrefix}/${s}`,
    // 3) –ø–∞–ø–∫–∞ = –ø–æ–ª–Ω–æ–µ –∏–º—è –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (shawl-1/shawl-1.jpg)
    `img/${base}/${s}`,
    // 4) –∫–æ—Ä–µ–Ω—å img
    `img/${s}`
  ];
  return Array.from(new Set(list));
}

function setSrcWithFallback(img, src, hintFolders){
  // –ë—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å: —É–∂–µ –∑–Ω–∞–µ–º —Ä–∞–±–æ—á–∏–π URL ‚Äî –Ω–µ –¥—ë—Ä–≥–∞–µ–º —Å–µ—Ç—å –ª–∏—à–Ω–∏–π —Ä–∞–∑
  if (RESOLVED_SRC[src]) {
    img.onerror = null;
    img.src = RESOLVED_SRC[src];
    return;
  }

  // –ï—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–π —Ö–∏–Ω—Ç –ø–∞–ø–∫–∏ (–±–µ—Ä—ë–º —Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π) ‚Äî –ø—Ä–æ–±—É–µ–º –°–†–ê–ó–£ –µ–≥–æ,
  // —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ 404 –≤ –∫–æ–Ω—Å–æ–ª–∏ –ø—Ä–∏ —Ö–æ–≤–µ—Ä–µ.
  let firstTry = '';
  if (Array.isArray(hintFolders) && hintFolders.length) {
    const s = String(src);
    const low = s.toLowerCase();
    if (!low.startsWith('http://') && !low.startsWith('https://')) {
      let file = s;
      if (low.startsWith('img/')) file = s.slice(4);
      else if (low.startsWith('./img/')) file = s.slice(6);
      else if (low.startsWith('/img/')) file = s.slice(5);
      if (!file.includes('/')) {
        firstTry = `img/${hintFolders[0]}/${file}`; // ¬´—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è¬ª –ø–∞–ø–∫–∞ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∫–∞–¥—Ä–∞
      }
    }
  }

  const arr = [];
  if (firstTry) arr.push(firstTry);            // <- –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ, –æ–±—ã—á–Ω–æ —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
  arr.push(...candidatesFor(src, hintFolders)); // –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
  arr.push('img/item-placeholder.jpg');

  let i = 0;
  const onLoad = () => { RESOLVED_SRC[src] = img.currentSrc || img.src; };
  img.addEventListener('load', onLoad, { once: true });

  const next = () => {
    if (i >= arr.length) { img.onerror = null; return; }
    const url = arr[i++];
    img.onerror = next;                 // –ø—Ä–∏ 404 –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π
    img.src = url;
  };
  next();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞–Ω–Ω–µ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∫–ª–∞–¥–∫–∏
function setHero(tab){
  if(!$hero) return;
  const next = (tab==='home') ? 'img/bannerh.jpg' : 'img/banner.jpg';
  // –ø–µ—Ä–≤—ã–π –ø–æ–∫–∞–∑ ‚Äî —Å–ª—É—à–∞–µ–º load –î–û —É—Å—Ç–∞–Ω–æ–≤–∫–∏ src, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
  if(!heroReady){
    const onFirstLoad = ()=>{
      $hero.style.visibility='visible';
      $hero.style.opacity='1';
      $hero.style.transform='translateX(0)';
      heroReady = true;
      $hero.removeEventListener('load', onFirstLoad);
    };
    $hero.addEventListener('load', onFirstLoad);
    if($hero.getAttribute('src')!==next) $hero.src = next;
    return;
  }
  if($hero.getAttribute('src')===next) return;

  const handleTransitionEnd = (e)=>{
    if(e.propertyName!=='opacity') return;
    $hero.removeEventListener('transitionend', handleTransitionEnd);
    const onLoad = () => {
      requestAnimationFrame(()=>{
        $hero.style.opacity='1';
        $hero.style.transform='translateX(0)';
      });
      $hero.removeEventListener('load', onLoad);
    };
    $hero.addEventListener('load', onLoad);
    $hero.src = next;
  };

  $hero.addEventListener('transitionend', handleTransitionEnd, {once:true});
  requestAnimationFrame(()=>{
    $hero.style.opacity='0';
    $hero.style.transform='translateX(-6px)';
  });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
function renderCollection(arr, instant=false){
  if(!$catalog) return;
  const src = arr.filter(it => !it.placeholder && (activeFilter==='all' ? true : (it.status||'stock')===activeFilter))
    .sort((a, b) => (a.order || 999) - (b.order || 999));

  closeModal();
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è
  if(!instant){ 
    $catalog.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
    $catalog.style.opacity='0'; 
    $catalog.style.visibility='hidden';
    $catalog.style.transform = 'translateY(10px)'; // –ù–µ–±–æ–ª—å—à–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
  }
  $catalog.innerHTML='';

  const realCount = (activeFilter==='all')
    ? arr.filter(it=>!it.placeholder).length
    : arr.filter(it=>!it.placeholder && (it.status||'stock')===activeFilter).length;

  if(realCount===0){
    const empty=document.createElement('div');
    empty.className='empty';
    empty.textContent='–ü–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç';
    $catalog.appendChild(empty);
  }

  src.forEach(it=>{
    const hints = folderHintsFromFirst(it.images[0]);
    const card=document.createElement('div');
    card.className='card'+(it.placeholder?' placeholder':'');
    const imgBox=document.createElement('div');imgBox.className='card-img';
    const img=document.createElement('img');
    setSrcWithFallback(img, it.images[0], hints); img.alt=it.title; img.draggable=false;
    img.addEventListener('dragstart', e=>e.preventDefault());
    imgBox.appendChild(img);
    card.appendChild(imgBox);
    const h3=document.createElement('h3');h3.textContent=it.title;card.appendChild(h3);
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞
    const priceText = it.price.replace(' —Ä.', '').replace('—Ä', '');
    const formattedPrice = priceText.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ‚ÇΩ';
    const price=document.createElement('div');price.className='price';price.textContent=formattedPrice;card.appendChild(price);
    if(!it.placeholder && it.status){ const st=document.createElement('div'); const cls=(it.status==='preorder')?'pre':'in'; st.className='status '+cls; st.textContent=(it.status==='preorder')?'–ø–æ–¥ –∑–∞–∫–∞–∑':'–≤ –Ω–∞–ª–∏—á–∏–∏'; card.appendChild(st);} 
    $catalog.appendChild(card);

    if(!it.placeholder){
      card.addEventListener('click',()=>openModal(it, currentTab));
    }
  });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
function renderActive(instant=false){
  if(!$catalog) return;
  const arr = (currentTab === 'home') ? items.filter(item => item.section === 'home') : items.filter(item => item.section === 'nessffo');
  console.log('renderActive –≤—ã–∑–≤–∞–Ω–∞:', {currentTab, itemsCount: items.length, filteredCount: arr.length});
  
  // –£–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–æ–π –∏ –ø–∞–Ω–µ–ª—å—é —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
  const $careBtn = document.getElementById('careBtn');
  const showInNessffo = currentTab === 'nessffo';
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º data-section –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Å—Ç–∏–ª–µ–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
  document.body.setAttribute('data-section', currentTab);
  
  if($careBtn){
    $careBtn.style.display = showInNessffo ? 'flex' : 'none';
  }
  
  if($carePanel){
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–±–∏–ª—å–Ω–æ–µ –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    const isMobile = window.innerWidth <= 768;
    
    if(showInNessffo){
      if(isMobile){
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–º—è—Ç–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        $carePanel.style.display = 'block';
      } else {
        // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Å–∫—Ä—ã–≤–∞–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É
        $carePanel.style.display = 'none';
      }
    } else {
      // –í —Ä–∞–∑–¥–µ–ª–µ home —Å–∫—Ä—ã–≤–∞–µ–º –≤–µ–∑–¥–µ
      $carePanel.style.display = 'none';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ (—Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ)
    if(showInNessffo && !isMobile && $careBtn && !$careBtn.hasAttribute('data-click-added')){
      $careBtn.setAttribute('data-click-added', 'true');
      $careBtn.addEventListener('click', function() {
        $carePanel.style.display = $carePanel.style.display === 'none' ? 'block' : 'none';
        $carePanel.classList.remove('collapsed');
      });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∫–∏
    if(showInNessffo && !$carePanel.hasAttribute('data-click-added')){
      $carePanel.setAttribute('data-click-added', 'true');
      $carePanel.addEventListener('click', function(e) {
        // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–ª–∏ —Å–∞–º—É –ø–∞–Ω–µ–ª—å, –Ω–æ –Ω–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞
        if(e.target.tagName === 'H4' || e.target.closest('h4') || (e.target === this && !e.target.closest('ul')) ){
          $carePanel.classList.toggle('collapsed');
        }
      });
    }
  }
  
  renderCollection(arr, instant);
  // –ø–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ç–∫—É (–µ—Å–ª–∏ –¥–æ —ç—Ç–æ–≥–æ –±—ã–ª —Å–∫–µ–ª–µ—Ç–æ–Ω)
  $catalog.style.display = 'grid';
  // –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º visibility –∏ opacity, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ instant —Ä–µ–Ω–¥–µ—Ä
  if(instant) {
    $catalog.style.visibility = 'visible';
    $catalog.style.opacity = '1';
  }
  // –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
  setHero(currentTab);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
(function tabs(){
  const tabs=document.querySelectorAll('.topnav .tab');
  const filterBtns = document.querySelectorAll('#filters .fbtn');
  const filterByTab = { home: 'all', nessffo: 'all' }; // –¥–µ—Ñ–æ–ª—Ç –Ω–∞ –≤–∫–ª–∞–¥–∫—É

  function setFilter(f){
    activeFilter=f;
    filterByTab[currentTab]=f;
    filterBtns.forEach(b=>b.classList.toggle('active', b.dataset.filter===f));
  }

  function activate(tab){
    tabs.forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      if(tab.classList.contains('active')) return;
      currentTab = tab.dataset.tab;
      activate(currentTab);
      setFilter(filterByTab[currentTab]);
      renderActive(true);
    });
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if(btn.classList.contains('active')) return;
      setFilter(btn.dataset.filter);
      renderActive(true);
    });
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  activate(currentTab);
  setFilter(filterByTab[currentTab]);
  renderActive(true);
})();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, —Ç–æ–≤–∞—Ä–æ–≤ –≤ –º–∞—Å—Å–∏–≤–µ:', items.length);
  if($catalog) {
    $catalog.style.display = 'grid';
    $catalog.style.visibility = 'visible';
    $catalog.style.opacity = '1';
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º —Ä–µ–Ω–¥–µ—Ä
    renderActive(true);
  }
});

