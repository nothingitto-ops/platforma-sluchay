// –û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ products.json: 2025-08-14 01:15:20

// ===== –§–£–ù–ö–¶–ò–û–ù–ê–õ –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô –ü–†–ò –ù–ê–í–ï–î–ï–ù–ò–ò –ö–£–†–°–û–†–ê =====
// –î–æ–±–∞–≤–ª–µ–Ω –≤ —Ñ—É–Ω–∫—Ü–∏–∏ renderCollection() –≤ —Å—Ç—Ä–æ–∫–∞—Ö ~1108-1160
// 
// –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
// 1. –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É (mouseenter/mouseover) —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ñ–ª–∞–≥ isHovering = true
// 2. –ü—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ (mousemove) –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –ø–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞—Ä—Ç–æ—á–∫–∏
// 3. –ù–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞ it.images
// 4. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é applyIdx() —Å –ø–æ–º–æ—â—å—é setSrcWithFallback()
// 5. –ü—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞ (mouseout/mouseleave) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –ø–µ—Ä–≤–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é (–∏–Ω–¥–µ–∫—Å 0)
// 
// –ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
// - isHovering: —Ñ–ª–∞–≥ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞
// - hoverRaf: requestAnimationFrame –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
// - currentHoverIndex: —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
// - applyIdx(): —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
//
// –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—á–∏–Ω–∏—Ç—å:
// 1. –ù–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é renderCollection() (—Å—Ç—Ä–æ–∫–∞ ~1038)
// 2. –ù–∞–π—Ç–∏ –±–ª–æ–∫ —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —Å–æ–±—ã—Ç–∏–π (—Å—Ç—Ä–æ–∫–∏ ~1108-1160)
// 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏: mouseenter, mousemove, mouseover, mouseout, mouseleave
// 4. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è applyIdx() –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç setSrcWithFallback()
// ========================================================================
const DEFAULT_TG = 'https://t.me/stub123';
/* ===== DATA (–≥–ª–∞–≤–Ω–∞—è) ===== */
const items = [
  {
    "images": [
      "product_2/product_2_1.jpg",
      "product_2/product_2_2.jpg",
      "product_2/product_2_3.jpg",
      "product_2/product_2_4.jpg"
    ],
    "title": "–ü–æ—è—Å-—é–±–∫–∞",
    "price": "3000 —Ä.",
    "desc": "–ü–æ—è—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –º–µ—à–∫–∞",
    "meta": "–°–æ—Å—Ç–∞–≤: 50% —Ö–ª–æ–ø–æ–∫ 50% –ª—ë–Ω",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 1,
    "section": "home"
  },
  {
    "images": [
      "product_1/product_1_1.jpg",
      "product_1/product_1_2.jpg",
      "product_1/product_1_3.jpg",
      "product_1/product_1_4.jpg"
    ],
    "title": "–ü–æ—è—Å —Ü–≤–µ—Ç–æ—á–Ω—ã–π",
    "price": "3000 —Ä.",
    "desc": "–ü–æ—è—Å, —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å nessffo, —Ä–∏—Å—É–Ω–æ–∫ –ø—Ä–∏ –ø–æ–º–æ—â–∏ —Ü–∏–∞–Ω–æ—Ç–∏–ø–∏–∏",
    "meta": "–°–æ—Å—Ç–∞–≤: 50% —Ö–ª–æ–ø–æ–∫ 50% –ª—ë–Ω",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 1,
    "section": "nessffo"
  },
  {
    "images": [
      "product_3/product_3_1.jpg",
      "product_3/product_3_2.jpg",
      "product_3/product_3_3.jpg",
      "product_3/product_3_4.jpg"
    ],
    "title": "–ü–æ—è—Å P1",
    "price": "3500 —Ä.",
    "desc": "–ü–æ—è—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –º–µ—à–∫–∞",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 2,
    "section": "home"
  },
  {
    "images": [
      "product_7/product_7_1.jpg",
      "product_7/product_7_2.jpg",
      "product_7/product_7_3.jpg",
      "product_7/product_7_4.jpg"
    ],
    "title": "–°—É–º–∫–∞ —á–µ—Ä–µ–∑ –ø–ª–µ—á–æ",
    "price": "4500 —Ä.",
    "desc": "–°—É–º–∫–∞, —Å–æ–∑–¥–∞–Ω–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å nessffo, —Ä–∏—Å—É–Ω–æ–∫ –ø—Ä–∏ –ø–æ–º–æ—â–∏ —Ü–∏–∞–Ω–æ—Ç–∏–ø–∏–∏",
    "meta": "–°–æ—Å—Ç–∞–≤: 50% —Ö–ª–æ–ø–æ–∫ 50% –ª—ë–Ω",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 2,
    "section": "nessffo"
  },
  {
    "images": [
      "product_4/product_4_1.jpg",
      "product_4/product_4_2.jpg",
      "product_4/product_4_3.jpg",
      "product_4/product_4_4.jpg",
      "product_4/product_4_5.jpg",
      "product_4/product_4_6.jpg"
    ],
    "title": "–†—É–±–∞—à–∫–∞",
    "price": "4000 —Ä.",
    "desc": "–õ—ë–≥–∫–∞—è —Ä—É–±–∞—à–∫–∞ —Å–æ —Å–≤–æ–±–æ–¥–Ω—ã–º–∏ —Ä—É–∫–∞–≤–∞–º–∏",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 3,
    "section": "home"
  },
  {
    "images": [
      "product_5/product_5_1.jpg",
      "product_5/product_5_2.jpg",
      "product_5/product_5_3.jpg",
      "product_5/product_5_4.jpg",
      "product_5/product_5_5.jpg"
    ],
    "title": "–®—Ç–∞–Ω—ã —Å –ø–æ—è—Å–æ–º U2",
    "price": "5800 —Ä.",
    "desc": "–°–≤–æ–±–æ–¥–Ω—ã–µ —à—Ç–∞–Ω—ã —Å —É–∫–æ—Ä–æ—á–µ–Ω–Ω—ã–º –ø–æ—è—Å–æ–º-—é–±–∫–æ–π",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 4,
    "section": "home"
  },
  {
    "images": [
      "product_6/product_6_1.jpg",
      "product_6/product_6_2.jpg",
      "product_6/product_6_3.jpg",
      "product_6/product_6_4.jpg",
      "product_6/product_6_5.jpg",
      "product_6/product_6_6.jpg"
    ],
    "title": "–†—É–±–∞—à–∫–∞ —Å –≤—ã—à–∏–≤–∫–æ–π",
    "price": "8000 —Ä.",
    "desc": "–†—É–±–∞—à–∫–∞ —Å –≤—ã—à–∏–≤–∫–æ–π",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% —Ö–ª–æ–ø–æ–∫ ¬∑ –î–µ–ª–∏–∫–∞—Ç–Ω–∞—è —Å—Ç–∏—Ä–∫–∞ 30¬∞C, –ø–æ—Å–ª–µ —Å—Ç–∏—Ä–∫–∏ —Ä—É–±–∞—à–∫–∞ –º–æ–∂–µ—Ç –æ–±—Ä–µ—Å—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç –≤–∞—Ä—ë–Ω–æ–π —Ç–∫–∞–Ω–∏",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 5,
    "section": "home"
  },
  {
    "images": [
      "product_8/product_8_1.jpg",
      "product_8/product_8_2.jpg",
      "product_8/product_8_3.jpg",
      "product_8/product_8_4.jpg"
    ],
    "title": "–†—É–±–∞—à–∫–∞ –∏ —à–æ—Ä—Ç—ã",
    "price": "7500 —Ä.",
    "desc": "–†—É–±–∞—à–∫–∞ –∏ —à–æ—Ä—Ç—ã",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 6,
    "section": "home"
  },
  {
    "images": [
      "product_9/product_9_1.jpg",
      "product_9/product_9_2.jpg",
      "product_9/product_9_3.jpg"
    ],
    "title": "–ü–ª–∞—Ç–æ–∫ –Ω–∞ —à–µ—é",
    "price": "1000 —Ä.",
    "desc": "–ü–ª–∞—Ç–æ–∫ —Å–µ—Ä–æ–≥–æ —Ü–≤–µ—Ç–∞",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –∂–∞—Ç–∞—è –≤–∏—Å–∫–æ–∑–∞ ¬∑ –î–µ–ª–∏–∫–∞—Ç–Ω–∞—è —Å—Ç–∏—Ä–∫–∞ 30¬∞C",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 7,
    "section": "home"
  },
  {
    "images": [
      "product_10/product_10_1.jpg",
      "product_10/product_10_2.jpg",
      "product_10/product_10_3.jpg"
    ],
    "title": "–®—Ç–∞–Ω—ã —Å –ø–æ—è—Å–æ–º U1",
    "price": "6000 —Ä.",
    "desc": "–°–≤–æ–±–æ–¥–Ω—ã–µ —à—Ç–∞–Ω—ã —Å –ø–æ—è—Å–æ–º-—é–±–∫–æ–π",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "preorder",
    "order": 8,
    "section": "home"
  },
  {
    "images": [
      "product_11/product_11_1.jpg",
      "product_11/product_11_2.jpg",
      "product_11/product_11_3.jpg",
      "product_11/product_11_4.jpg"
    ],
    "title": "–§–∞—Ä—Ç—É–∫",
    "price": "3000 —Ä.",
    "desc": "–§–∞—Ä—Ç—É–∫ –∏–º–µ–µ—Ç –∫–∞—Ä–º–∞–Ω –∏ –±—Ä–µ—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –¥–ª–∏–Ω—É –ø—Ä–∏ –ø–æ–º–æ—â–∏ –ø—É–≥–æ–≤–∏—Ü—ã",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –≤–∞—Ä–µ–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ü–≤–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä)",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 9,
    "section": "home"
  },
  {
    "images": [
      "product_12/product_12_1.jpg",
      "product_12/product_12_2.jpg",
      "product_12/product_12_3.jpg",
      "product_12/product_12_4.jpg"
    ],
    "title": "–ü–ª–∞—Ç–æ–∫ –Ω–∞ —à–µ—é",
    "price": "1000 —Ä.",
    "desc": "–ü–ª–∞—Ç–æ–∫ –º–æ–ª–æ—á–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞",
    "meta": "–°–æ—Å—Ç–∞–≤: 100% –∂–∞—Ç–∞—è –≤–∏—Å–∫–æ–∑–∞ ¬∑ –î–µ–ª–∏–∫–∞—Ç–Ω–∞—è —Å—Ç–∏—Ä–∫–∞ 30¬∞C",
    "link": "https://t.me/stub123",
    "status": "stock",
    "order": 10,
    "section": "home"
  }
]; // –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞

/* ===== GRID (–ø–µ—Ä–≤–∏—á–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥–ª–∞–≤–Ω–æ–π ‚Äî –û–°–¢–ê–í–õ–ï–ù–û –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ===== */
const $catalog=document.getElementById('catalog');
const __initialTab = (location.hash.replace('#','')==='nessffo') ? 'nessffo' : 'home';
const ENABLE_INITIAL_HOME_RENDER = false; // –æ—Ç–∫–ª—é—á–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –º–∏–≥–∞–ª–∞ –Ω–µ—Ü–µ–ª–µ–≤–æ–π —Ä–∞–∑–¥–µ–ª
if(ENABLE_INITIAL_HOME_RENDER && __initialTab==='home'){
  items.forEach(it=>{
    const card=document.createElement('div');
    card.className='card'+(it.placeholder?' placeholder':'');
    const imgBox=document.createElement('div');imgBox.className='card-img';
    const img=document.createElement('img');
    const _hints = folderHintsFromFirst((it.images && it.images[0])||'');
    setSrcWithFallback(img, (it.images&&it.images[0])||'img/item-placeholder.jpg', _hints);
    img.alt=it.title||''; img.draggable=false;
    img.addEventListener('dragstart', e=>e.preventDefault());
    imgBox.appendChild(img);
    card.appendChild(imgBox);
    const h3=document.createElement('h3');h3.textContent=it.title||'';card.appendChild(h3);
    const price=document.createElement('div');price.className='price';price.textContent=it.price||'';card.appendChild(price);
    if(!it.placeholder && it.status){ 
      const st=document.createElement('div'); 
      const cls=(it.status==='preorder')?'pre':'in'; 
      st.className='status '+cls; 
      st.textContent=(it.status==='preorder')?'–ø–æ–¥ –∑–∞–∫–∞–∑':'–≤ –Ω–∞–ª–∏—á–∏–∏';
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
      st.style.padding = '2px 6px';
      st.style.borderRadius = '4px';
      st.style.fontSize = '12px';
      st.style.fontWeight = '500';
      st.style.color = (it.status==='preorder') ? '#92400e' : '#065f46';
      st.style.backgroundColor = (it.status==='preorder') ? '#fef3c7' : '#f0fdf4';
      st.style.opacity = '0.8';
      st.style.border = 'none';
      card.appendChild(st);
    } 
    $catalog.appendChild(card);
    if(!it.placeholder) card.addEventListener('click',()=>openModal(it, currentTab));
  });
}

/* ===== MOD–ê–õ–ö–ê ===== */
const $modal=document.getElementById('modal');
const $viewer=document.getElementById('viewer');
const $viewerImg=document.getElementById('viewerImg');
const $thumbs=document.getElementById('thumbs');
const $zoomBtn=document.getElementById('zoomBtn');
const $mTitle=document.getElementById('mTitle');
const $mPrice=document.getElementById('mPrice');
const $mDesc=document.getElementById('mDesc');
const $mMeta=document.getElementById('mMeta');


const $carePanel=document.getElementById('carePanel');
const $mStatus=document.getElementById('mStatus');
const $mLink=document.getElementById('mLink');
const $hero=document.querySelector('.hero');
if ($hero) {
  $hero.setAttribute('decoding','async');
  $hero.setAttribute('loading','eager');
  $hero.setAttribute('fetchpriority','high');
}
const $topnav=document.querySelector('.topnav');

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–≤–∞–π–ø–æ–≤
let touchStartY = 0;
let touchStartX = 0;
let touchEndY = 0;
let touchEndX = 0;
let isSwiping = false;
let swipeThreshold = 100;
let isSwipeUp = false;
let sheetElement = null; // –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–≤–∞–π–ø–∞

function applyNavScroll(){ 
  if($topnav) {
    if(window.scrollY>8) $topnav.classList.add('scrolled'); 
    else $topnav.classList.remove('scrolled'); 
  }
}
window.addEventListener('scroll', applyNavScroll, {passive:true});
applyNavScroll();

const SHEET_TSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGdW7QcHV6BgZHJnSMzXKkmsXDYZulMojN312tgvI6PK86H8dRjReYUOHI2l_aVYzLg2NIjAcir89g/pub?output=tsv&t=20250810191426&v=20250810191426&nocache=1'; // ‚Üê –≤–∞—à–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ Google Sheets

let current=null,curIndex=0,zoomed=false, currentHints=[];
let dragging=false, startX=0, startY=0, tx=0, ty=0, moved=false;   // translate state
const SCALE=2; // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑—É–º–∞
const DRAG_THRESHOLD = 3; // px ‚Äî —á—Ç–æ–±—ã –∫–ª–∏–∫ –Ω–µ –ø—É—Ç–∞–ª—Å—è —Å –º–∏–∫—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è–º–∏

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
let currentTab = (location.hash.replace('#','')==='nessffo') ? 'nessffo' : 'home';
let activeFilter = 'all';
let heroReady = false;

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–≤–∞–π–ø–æ–≤
function handleTouchStart(e) {
  if (e.touches.length === 1) {
    touchStartY = e.touches[0].clientY;
    touchStartX = e.touches[0].clientX;
    isSwiping = false;
  }
}

function handleTouchMove(e) {
  if (e.touches.length === 1 && !zoomed) {
    touchEndY = e.touches[0].clientY;
    touchEndX = e.touches[0].clientX;
    
    const deltaY = touchStartY - touchEndY;
    const deltaX = touchStartX - touchEndX;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Å–≤–∞–π–ø (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∏–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π)
    if (Math.abs(deltaY) > 5 || Math.abs(deltaX) > 5) {
      isSwiping = true;
      
      // –î–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–≤–∞–π–ø–∞ –≤–≤–µ—Ä—Ö –¥–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
      if (Math.abs(deltaY) > Math.abs(deltaX) && deltaY > 0) {
        isSwipeUp = true;
        e.preventDefault();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —É–±–∏—Ä–∞–Ω–∏—è —Ç–µ–º–Ω–æ–≥–æ —Ñ–µ–π–¥–∞ —Å—Ä–∞–∑—É
        $modal.classList.add('swiping');
        
        // –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞ –ø–∞–ª—å—Ü–µ–º
        if (sheetElement) {
          // –ë–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ - –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–≤–∏–∂–µ—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ
          const resistance = 0.8; // 80% –æ—Ç –¥–≤–∏–∂–µ–Ω–∏—è –ø–∞–ª—å—Ü–∞
          const maxSwipe = window.innerHeight * 0.8; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø 80% –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
          const translateY = Math.min((deltaY * resistance), maxSwipe);
          const translatePercent = (translateY / maxSwipe) * 100;
          
          sheetElement.style.transform = `translateY(-${translatePercent}%)`;
          sheetElement.style.transition = 'none'; // –ë–µ–∑ transition –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞ –ø–∞–ª—å—Ü–µ–º
        }
      } else {
        isSwipeUp = false;
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö —Å–≤–∞–π–ø–æ–≤
        if (Math.abs(deltaY) > Math.abs(deltaX)) {
          e.preventDefault();
        }
      }
    }
  }
}

function handleTouchEnd(e) {
  if (isSwiping && !zoomed && current) {
    const deltaY = touchStartY - touchEndY;
    const deltaX = touchStartX - touchEndX;
    
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å swiping
    $modal.classList.remove('swiping');
    
    // –°–≤–∞–π–ø –≤–≤–µ—Ä—Ö –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ - –ø–æ—Ä–æ–≥ 35% –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
    const screenHeight = window.innerHeight;
    const threshold = screenHeight * 0.35; // 35% –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    
    if (deltaY > threshold && Math.abs(deltaY) > Math.abs(deltaX)) {
      // –ü–ª–∞–≤–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
      if (sheetElement) {
        $modal.classList.add('swipe-complete'); // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º —Ñ–µ–π–¥
        sheetElement.classList.add('swipe-complete');
        sheetElement.style.transform = 'translateY(-100%)';
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
          closeModal();
        }, 600);
      } else {
        closeModal();
      }
    } else if (isSwipeUp) {
      // –ï—Å–ª–∏ —Å–≤–∞–π–ø –Ω–µ –¥–æ—Å—Ç–∏–≥ –ø–æ—Ä–æ–≥–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–¥–∞–ª–∫—É –Ω–∞ –º–µ—Å—Ç–æ –ø–ª–∞–≤–Ω–æ
      if (sheetElement) {
        sheetElement.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        sheetElement.style.transform = 'translateY(0)';
        
        // –£–±–∏—Ä–∞–µ–º transition –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
          sheetElement.style.transition = 'none';
        }, 300);
      }
    }
    // –°–≤–∞–π–ø –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –¥–ª—è –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ
    else if (Math.abs(deltaX) > swipeThreshold && current.images.length > 1) {
      if (deltaX > 0) {
        // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ
        curIndex = (curIndex + 1) % current.images.length;
      } else {
        // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ
        curIndex = (curIndex - 1 + current.images.length) % current.images.length;
      }
      setMain(current.images[curIndex], true);
    }
  }
  
  isSwiping = false;
  isSwipeUp = false;
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤ –∫ –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É
function addSwipeHandlers() {
  const $sheet = document.querySelector('.modal .sheet');
  if ($sheet) {
    sheetElement = $sheet; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç
    $sheet.addEventListener('touchstart', handleTouchStart, { passive: false });
    $sheet.addEventListener('touchmove', handleTouchMove, { passive: false });
    $sheet.addEventListener('touchend', handleTouchEnd, { passive: true });
  }
}

// –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤
function removeSwipeHandlers() {
  const $sheet = document.querySelector('.modal .sheet');
  if ($sheet) {
    $sheet.removeEventListener('touchstart', handleTouchStart);
    $sheet.removeEventListener('touchmove', handleTouchMove);
    $sheet.removeEventListener('touchend', handleTouchEnd);
  }
}

function openModal(item, section){
  console.log('openModal –≤—ã–∑–≤–∞–Ω–∞, —à–∏—Ä–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞:', window.innerWidth);
  console.log('–¢–æ–≤–∞—Ä:', item.title, '—Å–µ–∫—Ü–∏—è:', section);
  console.log('–≠–ª–µ–º–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', $modal);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–±–∏–ª—å–Ω–æ–µ –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  if (window.innerWidth <= 768) {
    console.log('–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä');
    openFullscreenViewer(item, section);
  } else {
    console.log('–î–µ—Å–∫—Ç–æ–ø - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –º–æ–¥–∞–ª–∫—É');
    openDesktopModal(item, section);
  }
}

function openDesktopModal(item, section){
  console.log('openDesktopModal –≤—ã–∑–≤–∞–Ω–∞!');
  console.log('–≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', {
    modal: $modal,
    title: $mTitle,
    price: $mPrice,
    desc: $mDesc
  });
  current=item;curIndex=0;zoomed=false;moved=false;tx=ty=0;currentHints=folderHintsFromFirst(item.images[0]);
  if ($mTitle) $mTitle.textContent=item.title;
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É: —É–±–∏—Ä–∞–µ–º " —Ä." –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã + —Å–∏–º–≤–æ–ª ‚ÇΩ
  const priceText = item.price.replace(' —Ä.', '').replace('—Ä', '');
  const formattedPrice = priceText.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ‚ÇΩ';
  
  // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–µ–Ω—ã –∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  if ($mPrice) {
    $mPrice.innerHTML = '';
    const priceContainer = document.createElement('div');
    priceContainer.className = 'modal-price-container';
    
    // –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ü–µ–Ω—ã —Å —Å–∏–º–≤–æ–ª–æ–º —Ä—É–±–ª—è
    const priceElement = document.createElement('span');
    priceElement.className = 'price-text';
    priceElement.innerHTML = formattedPrice; // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML —á—Ç–æ–±—ã —Å–∏–º–≤–æ–ª —Ä—É–±–ª—è –Ω–µ —Ä–∞–∑–±–∏–≤–∞–ª—Å—è
    priceContainer.appendChild(priceElement);
  

  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä—è–º–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ü–µ–Ω–æ–π (–±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ div)
  if (item.status) {
    const statusText = document.createElement('span');
    const statusLabel = (item.status === 'preorder') ? '–ø–æ–¥ –∑–∞–∫–∞–∑' : '–≤ –Ω–∞–ª–∏—á–∏–∏';
    statusText.textContent = ' ' + statusLabel;
    statusText.style.marginLeft = '8px';
    statusText.style.padding = '2px 6px';
    statusText.style.borderRadius = '4px';
    statusText.style.fontSize = '12px';
    statusText.style.fontWeight = '500';
    statusText.style.color = item.status === 'preorder' ? '#92400e' : '#065f46';
    statusText.style.backgroundColor = item.status === 'preorder' ? '#fef3c7' : '#f0fdf4';
    statusText.style.opacity = '0.8';
    statusText.style.border = 'none !important';
    statusText.style.outline = 'none !important';
    statusText.style.boxShadow = 'none !important';
    statusText.style.borderWidth = '0 !important';
    statusText.style.borderStyle = 'none !important';
    statusText.style.borderColor = 'transparent !important';
    statusText.style.verticalAlign = 'middle';
    statusText.style.display = 'inline-block';
    priceElement.appendChild(statusText);
  }
  
  $mPrice.appendChild(priceContainer);
  }
  
  if ($mDesc) {
    $mDesc.textContent=item.desc;
    
    // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç
    $mDesc.style.setProperty('display', 'block', 'important');
    $mDesc.style.setProperty('overflow', 'visible', 'important');
    $mDesc.style.setProperty('height', 'auto', 'important');
    $mDesc.style.setProperty('max-height', 'none', 'important');
  }
  if ($mMeta) $mMeta.textContent=item.meta||'';
  if ($mLink) $mLink.href=item.link;
  // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –æ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å —Ü–µ–Ω–æ–π
  if ($mStatus) {
    $mStatus.style.display='none';
  }
  setMain(item.images[0], true);
  renderThumbs(item.images);
  leaveZoom();
  if ($modal) {
    $modal.classList.add('open');
  }
  document.body.style.overflow='hidden';
  addSwipeHandlers(); // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
}

function openFullscreenViewer(item, section){
  console.log('openFullscreenViewer –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞:', item.title);
  console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', item.images);
  console.log('openFullscreenViewer –≤—ã–∑–≤–∞–Ω–∞!');
  
  current = item;
  curIndex = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å –∫ –ø–µ—Ä–≤–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
  zoomed = false;
  moved = false;
  tx = ty = 0;
  currentHints = folderHintsFromFirst(item.images[0]);
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ
  const fullscreenTitle = document.getElementById('fullscreenTitle');
  if (fullscreenTitle) {
    fullscreenTitle.textContent = item.title;
    console.log('–ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', item.title);
  } else {
    console.error('–≠–ª–µ–º–µ–Ω—Ç fullscreenTitle –Ω–µ –Ω–∞–π–¥–µ–Ω!');
  }
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É
  const priceText = item.price.replace(' —Ä.', '').replace('—Ä', '');
  const formattedPrice = priceText.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ‚ÇΩ';
  const priceElement = document.querySelector('#fullscreenPrice .fullscreen-price-text');
  if (priceElement) {
    priceElement.innerHTML = formattedPrice; // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML —á—Ç–æ–±—ã —Å–∏–º–≤–æ–ª —Ä—É–±–ª—è –Ω–µ —Ä–∞–∑–±–∏–≤–∞–ª—Å—è
    console.log('–¶–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', formattedPrice);
    

  } else {
    console.error('–≠–ª–µ–º–µ–Ω—Ç —Ü–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω!');
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä—è–º–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ü–µ–Ω–æ–π –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ
  if (item.status) {
    const statusText = document.createElement('span');
    const statusLabel = (item.status === 'preorder') ? '–ø–æ–¥ –∑–∞–∫–∞–∑' : '–≤ –Ω–∞–ª–∏—á–∏–∏';
    statusText.textContent = ' ' + statusLabel;
    statusText.style.marginLeft = '8px';
    statusText.style.padding = '2px 6px';
    statusText.style.borderRadius = '4px';
    statusText.style.fontSize = '12px';
    statusText.style.fontWeight = '500';
    statusText.style.color = item.status === 'preorder' ? '#92400e' : '#065f46';
    statusText.style.backgroundColor = item.status === 'preorder' ? '#fef3c7' : '#f0fdf4';
    statusText.style.opacity = '0.8';
    statusText.style.border = 'none !important';
    statusText.style.outline = 'none !important';
    statusText.style.boxShadow = 'none !important';
    statusText.style.borderWidth = '0 !important';
    statusText.style.borderStyle = 'none !important';
    statusText.style.borderColor = 'transparent !important';
    statusText.style.verticalAlign = 'middle';
    statusText.style.display = 'inline-block';
    priceElement.appendChild(statusText);
  }
  

  
  const fullscreenDesc = document.getElementById('fullscreenDesc');
  if (fullscreenDesc) {
    fullscreenDesc.textContent = item.desc;
    // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ
    fullscreenDesc.style.setProperty('display', 'block', 'important');
    fullscreenDesc.style.setProperty('overflow', 'visible', 'important');
    fullscreenDesc.style.setProperty('height', 'auto', 'important');
    fullscreenDesc.style.setProperty('max-height', 'none', 'important');
  }
  
  const fullscreenMeta = document.getElementById('fullscreenMeta');
  if (fullscreenMeta) fullscreenMeta.textContent = item.meta || '';
  
  const fullscreenLink = document.getElementById('fullscreenLink');
  if (fullscreenLink) fullscreenLink.href = item.link;
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  console.log('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:', item.images[0]);
  setFullscreenMain(item.images[0], true);
  
  // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
  console.log('–°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏ –¥–ª—è', item.images.length, '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
  renderFullscreenDots(item.images);
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
  const fullscreenViewer = document.getElementById('fullscreenViewer');
  if (fullscreenViewer) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
    fullscreenViewer.classList.remove('expanded');
    fullscreenViewer.classList.add('open');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    const fullscreenExpandBtn = document.getElementById('fullscreenExpandBtn');
    if (fullscreenExpandBtn) {
      fullscreenExpandBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
      `;
    }
    
    console.log('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∫—Ä—ã—Ç');
  } else {
    console.error('–≠–ª–µ–º–µ–Ω—Ç fullscreenViewer –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    // Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –º–æ–¥–∞–ª–∫—É
    console.log('Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –º–æ–¥–∞–ª–∫—É');
    openDesktopModal(item, section);
  }
  
  document.body.style.overflow = 'hidden';
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  addFullscreenHandlers();
}
function closeModal(){
  // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã –∞–Ω–∏–º–∞—Ü–∏–∏
  $modal.classList.remove('open', 'swipe-complete', 'swiping');
  document.body.style.overflow='';
  leaveZoom();
  moved=false; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å moved –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
  removeSwipeHandlers(); // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
  if (sheetElement) {
    sheetElement.style.transform = '';
    sheetElement.style.transition = 'none';
    sheetElement.classList.remove('swipe-complete', 'wobble');
  }
  
  // –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
  const dots = document.querySelector('.image-dots');
  if (dots) dots.remove();
}
if($modal) $modal.addEventListener('click',closeModal);
const closeBtn = document.getElementById('closeBtn');
if(closeBtn) closeBtn.addEventListener('click',closeModal);

function renderThumbs(arr){
  $thumbs.innerHTML='';
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  if (window.innerWidth <= 768 && arr.length > 1) {
    const dotsContainer = document.createElement('div');
    dotsContainer.className = 'image-dots';
    arr.forEach((_, idx) => {
      const dot = document.createElement('div');
      dot.className = `image-dot ${idx === curIndex ? 'active' : ''}`;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏
      dot.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('–ö–ª–∏–∫ –ø–æ —Ç–æ—á–∫–µ –≤ –º–æ–¥–∞–ª–∫–µ:', idx);
        
        if (curIndex !== idx) {
          curIndex = idx;
          setMain(arr[idx], true);
          updateModalDots();
        }
      });
      
      dotsContainer.appendChild(dot);
    });
    $viewer.appendChild(dotsContainer);
  }
  
  arr.forEach((src,i)=>{
    const t=document.createElement('img');
    setSrcWithFallback(t, src, currentHints); t.alt='';
    t.draggable=false;
    t.addEventListener('dragstart', e=>e.preventDefault());
    if(i===curIndex)t.classList.add('active');
    t.onclick=()=>{
      curIndex=i;
      setMain(src, true);
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏
      document.querySelectorAll('.image-dot').forEach((dot, idx) => {
        dot.classList.toggle('active', idx === i);
      });
    };
    $thumbs.appendChild(t);
  });
}

/* === –ú–ì–ù–û–í–ï–ù–ù–ê–Ø —Å–º–µ–Ω–∞ –∫–∞–¥—Ä–∞, –±–µ–∑ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ === */
function setMain(src, snap=false){
  if(!$viewerImg || !$thumbs) return;
  leaveZoom();                 // —Å–±—Ä–æ—Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π
  if (snap) $viewerImg.style.transition = 'none'; // –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
  setSrcWithFallback($viewerImg, src, currentHints);
  
  // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  if (window.innerWidth <= 768) {
    $viewerImg.onload = function() {
      const isVertical = this.naturalHeight > this.naturalWidth;
      if (isVertical) {
        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ - –ø–æ —à–∏—Ä–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞
        this.style.width = '100%';
        this.style.height = 'auto';
        this.style.maxHeight = 'none';
        this.style.objectFit = 'cover';
      } else {
        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ - –ø–æ –≤—ã—Å–æ—Ç–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
        this.style.width = 'auto';
        this.style.height = '100%';
        this.style.maxWidth = '100%';
        this.style.objectFit = 'contain';
      }
    };
  }
  
  // –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–µ–≤—å—é
  [...$thumbs.children].forEach((el,i)=>el.classList.toggle('active',i===curIndex));
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
  document.querySelectorAll('.image-dot').forEach((dot, idx) => {
    dot.classList.toggle('active', idx === curIndex);
  });
}

/* –õ–∏—Å—Ç–∞–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É –ø–æ –∫—Ä–∞—è–º ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ù–ï –∑—É–º */
if($viewer) {
  $viewer.addEventListener('click',e=>{
    console.log('–ö–ª–∏–∫ –ø–æ viewer, zoomed:', zoomed);
    if(zoomed) return; // –≤ –∑—É–º–µ –∫–ª–∏–∫–∏ –∏–≥–Ω–æ—Ä–∏–º
    const rect=$viewer.getBoundingClientRect();
    const left=(e.clientX-rect.left) < rect.width/2;
    console.log('–ö–ª–∏–∫ –ø–æ viewer:', left ? '–ª–µ–≤–æ–π' : '–ø—Ä–∞–≤–æ–π', '—Å—Ç–æ—Ä–æ–Ω–µ');
    curIndex=(curIndex+(left?-1:1)+current.images.length)%current.images.length;
    console.log('–ù–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å –∏–∑ viewer:', curIndex);
    setMain(current.images[curIndex], true);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∫—Ä–∞—è–º
    document.querySelectorAll('.image-dot').forEach((dot, idx) => {
      dot.classList.toggle('active', idx === curIndex);
    });
  });
}

/* === –ó–£–ú ===
   ‚Äî –ö–Ω–æ–ø–∫–∞ üîç: –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç
   ‚Äî –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é: –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç
   ‚Äî –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ, –±–µ–∑ ¬´wobbling¬ª –∏ –±–µ–∑ drag ghost
*/
if($zoomBtn) {
  console.log('–ö–Ω–æ–ø–∫–∞ –∑—É–º–∞ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫');
  $zoomBtn.addEventListener('click',(e)=>{
    console.log('–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –∑—É–º–∞, zoomed:', zoomed);
    e.preventDefault();
    e.stopPropagation();
    if(zoomed) {
      console.log('–í—ã—Ö–æ–¥–∏–º –∏–∑ –∑—É–º–∞');
      leaveZoom();
    } else {
      console.log('–í—Ö–æ–¥–∏–º –≤ –∑—É–º');
      enterZoom();
    }
  });
} else {
  console.log('–ö–Ω–æ–ø–∫–∞ –∑—É–º–∞ –ù–ï –Ω–∞–π–¥–µ–Ω–∞!');
}
if($viewerImg) {
  $viewerImg.addEventListener('dblclick', (e)=>{
    e.preventDefault();
    e.stopPropagation();
    if(zoomed) leaveZoom(); // –≤—Ö–æ–¥ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É; dblclick ‚Äî —Ç–æ–ª—å–∫–æ –≤—ã—Ö–æ–¥
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ª–∏—Å—Ç–∞–Ω–∏—è
  $viewerImg.addEventListener('click', (e)=>{
    console.log('–ö–ª–∏–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é, zoomed:', zoomed);
    if(zoomed) return; // –≤ –∑—É–º–µ –∫–ª–∏–∫–∏ –∏–≥–Ω–æ—Ä–∏–º
    e.preventDefault();
    e.stopPropagation();
    
    const rect = $viewerImg.getBoundingClientRect();
    const left = (e.clientX - rect.left) < rect.width / 2;
    console.log('–ö–ª–∏–∫ –ø–æ', left ? '–ª–µ–≤–æ–π' : '–ø—Ä–∞–≤–æ–π', '—Å—Ç–æ—Ä–æ–Ω–µ');
    curIndex = (curIndex + (left ? -1 : 1) + current.images.length) % current.images.length;
    console.log('–ù–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å:', curIndex);
    setMain(current.images[curIndex], true);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∫—Ä–∞—è–º
    document.querySelectorAll('.image-dot').forEach((dot, idx) => {
      dot.classList.toggle('active', idx === curIndex);
    });
  });
}

function enterZoom(){
  if(!$viewerImg) return;
  zoomed=true;tx=ty=0;
  $viewerImg.style.transition='none';
  $viewerImg.style.transform=`translate(0px,0px) scale(${SCALE})`;
  $viewerImg.style.cursor='grab';
}
function leaveZoom(){
  if(!$viewerImg) return;
  zoomed=false;dragging=false;moved=false;tx=ty=0;
  $viewerImg.style.transition='none';
  $viewerImg.style.transform='translate(0px,0px) scale(1)';
  $viewerImg.style.cursor='default';
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ moved –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∑—É–º–∞
  moved = false;
}

/* ‚Äî‚Äî‚Äî –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Pointer Events (—á—Ç–æ–± –±–µ–∑ ghost-–∏–∫–æ–Ω–æ–∫) ‚Äî‚Äî‚Äî */
if($viewerImg) {
  $viewerImg.addEventListener('dragstart', e=>e.preventDefault());

  $viewerImg.addEventListener('pointerdown', e=>{
    if(!zoomed) return;
    e.preventDefault(); // –Ω–µ –¥–∞—ë–º –±—Ä–∞—É–∑–µ—Ä—É –Ω–∞—á–∏–Ω–∞—Ç—å drag-image
    $viewerImg.setPointerCapture(e.pointerId);
    dragging=true; moved=false;
    startX=e.clientX; startY=e.clientY;
    $viewerImg.style.cursor='grabbing';
  });

  $viewerImg.addEventListener('pointermove', e=>{
    if(!zoomed || !dragging) return;
    const dx=e.clientX-startX, dy=e.clientY-startY;
    if (!moved && (Math.abs(dx)>DRAG_THRESHOLD || Math.abs(dy)>DRAG_THRESHOLD)) moved=true;

    const nextX=tx+dx, nextY=ty+dy;
    const bounds=getBounds();
    const clampedX=Math.max(bounds.minX, Math.min(bounds.maxX, nextX));
    const clampedY=Math.max(bounds.minY, Math.min(bounds.maxY, nextY));
    $viewerImg.style.transform=`translate(${clampedX}px,${clampedY}px) scale(${SCALE})`;
  });

  $viewerImg.addEventListener('pointerup', e=>{
    if(!zoomed) return;
    $viewerImg.releasePointerCapture(e.pointerId);
    dragging=false;
    // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–º–µ—â–µ–Ω–∏–µ –∏–∑ transform:
    const m = /translate\(([-\d.]+)px,\s*([-\d.]+)px\)/.exec($viewerImg.style.transform);
    if(m){ tx=parseFloat(m[1]); ty=parseFloat(m[2]); }
    $viewerImg.style.cursor='grab';
  });
}

/* –ì—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–µ—Ä–µ—Ç—è–≥–∏–≤–∞–Ω–∏—è –≤ –∑—É–º–µ */
function getBounds(){
  if(!$viewerImg || !$viewer) return {minX:0, maxX:0, minY:0, maxY:0};
  const iw=$viewerImg.naturalWidth, ih=$viewerImg.naturalHeight;
  const cw=$viewer.clientWidth, ch=$viewer.clientHeight;
  // —Ä–∞–∑–º–µ—Ä—ã –≤–ø–∏—Å–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø—Ä–∏ scale=1
  const imgAspect=iw/ih, boxAspect=cw/ch;
  let fittedW, fittedH;
  if(imgAspect>boxAspect){ fittedW=cw; fittedH=cw/imgAspect; }
  else { fittedH=ch; fittedW=ch*imgAspect; }

  const zw = fittedW * SCALE;
  const zh = fittedH * SCALE;
  const maxX = Math.max(0, (zw - cw)/2);
  const maxY = Math.max(0, (zh - ch)/2);
  return {minX:-maxX, maxX, minY:-maxY, maxY};
}

window.addEventListener('keydown',e=>{ 
  if(e.key==='Escape') {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
    const fullscreenViewer = document.getElementById('fullscreenViewer');
    if (fullscreenViewer && fullscreenViewer.classList.contains('open')) {
      closeFullscreenViewer();
    } else {
      closeModal();
    }
  }
});

// –ö—ç—à –¥–ª—è —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—É—Ç–µ–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
const RESOLVED_SRC = Object.create(null);

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø—É—Ç–µ–π —Å —É—á—ë—Ç–æ–º –≤–æ–∑–º–æ–∂–Ω–æ–π –ø–æ–¥–ø–∞–ø–∫–∏
function folderHintsFromFirst(first){
  if(!first) return [];
  let s = String(first).trim();
  const low = s.toLowerCase();
  // –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä —è–≤–Ω–æ —É–∫–∞–∑–∞–ª –ø–æ–¥–ø—É—Ç—å "folder/file.jpg" ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ —Ö–∏–Ω—Ç
  if (s.includes('/')) {
    const dir = s.split('/')[0].replace(/^\.\/?|^img\//,'');
    return [dir];
  }
  // –∏–Ω–∞—á–µ —Å—Ç—Ä–æ–∏–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏–∑ –∏–º–µ–Ω–∏ –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞
  if (low.startsWith('img/')) s = s.slice(4);
  const dot = s.lastIndexOf('.');
  const base = dot > 0 ? s.slice(0, dot) : s; // –Ω–∞–ø—Ä. shawl-1
  const lastDash = base.lastIndexOf('-');
  const prefix   = lastDash > 0 ? base.slice(0, lastDash) : base; // shawl
  // –≤—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–∏—Å –ø–µ—Ä–µ–¥ —Ö–≤–æ—Å—Ç–æ–≤—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ –±—ã–ª–æ (apron1 -> apron-1)
  let dashedPrefix = prefix;
  let i = prefix.length - 1;
  while (i >= 0) { const code = prefix.charCodeAt(i); if (code < 48 || code > 57) break; i--; }
  if (i < prefix.length - 1 && prefix[i] !== '-') {
    dashedPrefix = prefix.slice(0, i + 1) + '-' + prefix.slice(i + 1);
  }
  return Array.from(new Set([dashedPrefix, prefix, base].filter(Boolean)));
}

// –î–µ–ª–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—É—Ç–∏ –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤—ã–π —É–¥–∞—á–Ω—ã–π.
function candidatesFor(src, hintFolders){
  if(!src) return ['img/item-placeholder.jpg'];
  let s = String(src);
  const low = s.toLowerCase();
  // –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ URL ‚Äî –∫–∞–∫ –µ—Å—Ç—å
  if (low.startsWith('http://') || low.startsWith('https://')) return [s];
  // —É–±—Ä–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å img/
  if (low.startsWith('img/')) s = s.slice(4);
  else if (low.startsWith('./img/')) s = s.slice(6);
  else if (low.startsWith('/img/')) s = s.slice(5);
  // –µ—Å–ª–∏ —É–∂–µ —É–∫–∞–∑–∞–Ω –ø–æ–¥–ø—É—Ç—å –≤–∏–¥–∞ folder/file.jpg ‚Äî –ø—Ä–æ–±—É–µ–º –∫–∞–∫ –µ—Å—Ç—å (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º img/)
  if (s.includes('/')) return ['img/' + s];

  // –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
  const dot = s.lastIndexOf('.');
  const base = dot > 0 ? s.slice(0, dot) : s;            // –Ω–∞–ø—Ä. apron1-1
  const lastDash = base.lastIndexOf('-');
  const prefix   = lastDash > 0 ? base.slice(0, lastDash) : base; // –Ω–∞–ø—Ä. apron1

  // –¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–∏—Å –ø–µ—Ä–µ–¥ —Ö–≤–æ—Å—Ç–æ–≤—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏: apron1 -> apron-1
  let dashedPrefix = prefix;
  let i = prefix.length - 1;
  while (i >= 0) { const code = prefix.charCodeAt(i); if (code < 48 || code > 57) break; i--; }
  if (i < prefix.length - 1 && prefix[i] !== '-') {
    dashedPrefix = prefix.slice(0, i + 1) + '-' + prefix.slice(i + 1);
  }

  // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–¥–ø–∞–ø–æ–∫: —Å–Ω–∞—á–∞–ª–∞ –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–µ (shawl-2 —Ä–∞–Ω—å—à–µ shawl-2-1)
  const hints = Array.isArray(hintFolders)
    ? Array.from(new Set(hintFolders)).sort((a,b)=>{
        const ad = a.includes('-'), bd = b.includes('-');
        if(ad && !bd) return -1; // –ø–∞–ø–∫–∏ —Å –¥–µ—Ñ–∏—Å–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ
        if(bd && !ad) return 1;
        return a.length - b.length; // –∑–∞—Ç–µ–º –ø–æ –¥–ª–∏–Ω–µ ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ —Ä–∞–Ω—å—à–µ
      })
    : [];

  const list = [
    // 0) –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –ø–∞–ø–∫–∏ –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–æ—Ç –∫–æ—Ä–æ—Ç–∫–∏—Ö –∫ –¥–ª–∏–Ω–Ω—ã–º)
    ...hints.map(h => `img/${h}/${s}`),
    // 1) –ø–∞–ø–∫–∞ = —á–∞—Å—Ç—å –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ—Ñ–∏—Å–∞ (belt-skirt-1/belt-skirt-1-1.jpg)
    `img/${prefix}/${s}`,
    // 2) —á–∞—Å—Ç—å + –¥–µ—Ñ–∏—Å –ø–µ—Ä–µ–¥ —Ü–∏—Ñ—Ä–∞–º–∏ (apron-1/apron1-1.jpg)
    `img/${dashedPrefix}/${s}`,
    // 3) –ø–∞–ø–∫–∞ = –ø–æ–ª–Ω–æ–µ –∏–º—è –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (shawl-1/shawl-1.jpg)
    `img/${base}/${s}`,
    // 4) –∫–æ—Ä–µ–Ω—å img
    `img/${s}`
  ];
  return Array.from(new Set(list));
}

function setSrcWithFallback(img, src, hintFolders){
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  img.onerror = null;
  img.onload = null;
  
  // –ë—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å: —É–∂–µ –∑–Ω–∞–µ–º —Ä–∞–±–æ—á–∏–π URL
  if (RESOLVED_SRC[src]) {
    img.src = RESOLVED_SRC[src];
    return;
  }

  // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—ã–π –ø—É—Ç—å –∏–∑ JSON
  let finalSrc = src;
  
  // –ï—Å–ª–∏ –ø—É—Ç—å –Ω–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å img/
  if (src && !src.startsWith('http://') && !src.startsWith('https://')) {
    if (!src.startsWith('img/')) {
      finalSrc = 'img/' + src;
    }
  }

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  img.onload = function() { 
    RESOLVED_SRC[src] = img.currentSrc || img.src; 
    img.onload = null;
    img.onerror = null;
  };
  
  img.onerror = function() {
    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
    img.src = 'img/item-placeholder.jpg';
    img.onload = null;
    img.onerror = null;
  };
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  img.src = finalSrc;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞–Ω–Ω–µ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∫–ª–∞–¥–∫–∏
function setHero(tab){
  if(!$hero) return;
  const next = (tab==='home') ? 'img/bannerh.jpg' : 'img/banner.jpg';
  // –ø–µ—Ä–≤—ã–π –ø–æ–∫–∞–∑ ‚Äî —Å–ª—É—à–∞–µ–º load –î–û —É—Å—Ç–∞–Ω–æ–≤–∫–∏ src, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
  if(!heroReady){
    const onFirstLoad = ()=>{
      $hero.style.visibility='visible';
      $hero.style.opacity='1';
      $hero.style.transform='translateX(0)';
      heroReady = true;
      $hero.removeEventListener('load', onFirstLoad);
    };
    $hero.addEventListener('load', onFirstLoad);
    if($hero.getAttribute('src')!==next) $hero.src = next;
    return;
  }
  if($hero.getAttribute('src')===next) return;

  const handleTransitionEnd = (e)=>{
    if(e.propertyName!=='opacity') return;
    $hero.removeEventListener('transitionend', handleTransitionEnd);
    const onLoad = () => {
      requestAnimationFrame(()=>{
        $hero.style.opacity='1';
        $hero.style.transform='translateX(0)';
      });
      $hero.removeEventListener('load', onLoad);
    };
    $hero.addEventListener('load', onLoad);
    $hero.src = next;
  };

  $hero.addEventListener('transitionend', handleTransitionEnd, {once:true});
  requestAnimationFrame(()=>{
    $hero.style.opacity='0';
    $hero.style.transform='translateX(-6px)';
  });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
function renderCollection(arr, instant=false){
  if(!$catalog) return;
  console.log('renderCollection –≤—ã–∑–≤–∞–Ω–∞, —Ç–æ–≤–∞—Ä–æ–≤ –≤ –º–∞—Å—Å–∏–≤–µ:', arr.length);
  
  const src = arr.filter(it => {
    const isNotPlaceholder = !it.placeholder;
    const matchesFilter = activeFilter==='all' ? true : (it.status||'stock')===activeFilter;
    console.log(`–¢–æ–≤–∞—Ä ${it.title}: placeholder=${it.placeholder}, status=${it.status}, matchesFilter=${matchesFilter}`);
    return isNotPlaceholder && matchesFilter;
  }).sort((a, b) => (a.order || 999) - (b.order || 999));
  
  console.log('–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', src.length, '–∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä:', activeFilter);
  console.log('–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:', src.map(item => `${item.title} (${item.status})`));

  closeModal();
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è
  if(!instant){ 
    $catalog.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
    $catalog.style.opacity='0'; 
    $catalog.style.visibility='hidden';
    $catalog.style.transform = 'translateY(10px)'; // –ù–µ–±–æ–ª—å—à–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
  }
  $catalog.innerHTML='';

  const realCount = (activeFilter==='all')
    ? arr.filter(it=>!it.placeholder).length
    : arr.filter(it=>!it.placeholder && (it.status||'stock')===activeFilter).length;

  if(realCount===0){
    const empty=document.createElement('div');
    empty.className='empty';
    empty.textContent='–ü–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç';
    $catalog.appendChild(empty);
  }

  src.forEach(it=>{
    const hints = folderHintsFromFirst(it.images[0]);
    const card=document.createElement('div');
    card.className='card'+(it.placeholder?' placeholder':'');
    const imgBox=document.createElement('div');imgBox.className='card-img';
    const img=document.createElement('img');
    setSrcWithFallback(img, it.images[0], hints); img.alt=it.title; img.draggable=false;
    img.addEventListener('dragstart', e=>e.preventDefault());
    imgBox.appendChild(img);
    card.appendChild(imgBox);
    const h3=document.createElement('h3');h3.textContent=it.title;card.appendChild(h3);
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞
    const priceText = it.price.replace(' —Ä.', '').replace('—Ä', '');
    const formattedPrice = priceText.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ‚ÇΩ';
    const price=document.createElement('div');price.className='price';price.textContent=formattedPrice;card.appendChild(price);
    if(!it.placeholder && it.status){ 
      const st=document.createElement('div'); 
      const cls=(it.status==='preorder')?'pre':'in'; 
      st.className='status '+cls; 
      st.textContent=(it.status==='preorder')?'–ø–æ–¥ –∑–∞–∫–∞–∑':'–≤ –Ω–∞–ª–∏—á–∏–∏';
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
      st.style.padding = '2px 6px';
      st.style.borderRadius = '4px';
      st.style.fontSize = '12px';
      st.style.fontWeight = '500';
      st.style.color = (it.status==='preorder') ? '#92400e' : '#065f46';
      st.style.backgroundColor = (it.status==='preorder') ? '#fef3c7' : '#f0fdf4';
      st.style.opacity = '0.8';
      st.style.border = 'none';
      card.appendChild(st);
    } 
    $catalog.appendChild(card);

    if(!it.placeholder){
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
      let isHovering = false;
      let hoverRaf = 0;
      let currentHoverIndex = 0;
      
      const applyIdx = (idx) => {
        if (idx !== currentHoverIndex && idx < it.images.length) {
          currentHoverIndex = idx;
          setSrcWithFallback(img, it.images[idx], folderHintsFromFirst(it.images[idx]));
        }
      };
      
      imgBox.addEventListener('mouseenter', () => {
        isHovering = true;
      });
      
      imgBox.addEventListener('mousemove', e => {
        if (!isHovering) return;
        
        if (hoverRaf) {
          cancelAnimationFrame(hoverRaf);
        }
        
        hoverRaf = requestAnimationFrame(() => {
          hoverRaf = 0;
          const rect = imgBox.getBoundingClientRect();
          const ratio = (e.clientX - rect.left) / rect.width;
          const idx = Math.min(it.images.length - 1, Math.max(0, Math.floor(ratio * it.images.length)));
          if (idx !== currentHoverIndex) {
            applyIdx(idx);
          }
        });
      });
      
      imgBox.addEventListener('mouseover', () => {
        isHovering = true;
      });
      
      imgBox.addEventListener('mouseout', () => {
        isHovering = false;
        if (hoverRaf) {
          cancelAnimationFrame(hoverRaf);
          hoverRaf = 0;
        }
        if (currentHoverIndex !== 0) {
          applyIdx(0);
        }
      });
      
      imgBox.addEventListener('mouseleave', () => {
        isHovering = false;
        if (hoverRaf) {
          cancelAnimationFrame(hoverRaf);
          hoverRaf = 0;
        }
        if (currentHoverIndex !== 0) {
          applyIdx(0);
        }
      });
      
      card.addEventListener('click', (e) => {
        console.log('–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ:', it.title, '–≤–∫–ª–∞–¥–∫–∞:', currentTab);
        e.stopPropagation();
        openModal(it, currentTab);
      });
    }
  });
  
  console.log('–ö–∞—Ç–∞–ª–æ–≥ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω, –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–æ–∑–¥–∞–Ω–æ:', src.length);
  
  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã
  const actualCards = $catalog.querySelectorAll('.card');
  console.log('–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ DOM:', actualCards.length);
  
  if (actualCards.length !== src.length) {
    console.error('–û–®–ò–ë–ö–ê: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ DOM –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º!');
  }
  

  

}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
function renderActive(instant=false){
  if(!$catalog) return;
  const arr = (currentTab === 'home') ? items.filter(item => item.section === 'home') : items.filter(item => item.section === 'nessffo');
  console.log('renderActive –≤—ã–∑–≤–∞–Ω–∞:', {currentTab, itemsCount: items.length, filteredCount: arr.length});
  console.log('–¢–æ–≤–∞—Ä—ã –≤ —Å–µ–∫—Ü–∏–∏', currentTab, ':', arr.map(item => `${item.title} (${item.status})`));
  
  // –£–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–æ–π –∏ –ø–∞–Ω–µ–ª—å—é —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
  const $careBtn = document.getElementById('careBtn');
  const showInNessffo = currentTab === 'nessffo';
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º data-section –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Å—Ç–∏–ª–µ–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
  document.body.setAttribute('data-section', currentTab);
  
  if($careBtn){
    $careBtn.style.display = showInNessffo ? 'flex' : 'none';
  }
  
  if($carePanel){
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–±–∏–ª—å–Ω–æ–µ –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    const isMobile = window.innerWidth <= 768;
    
    if(showInNessffo){
      if(isMobile){
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–º—è—Ç–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        $carePanel.style.display = 'block';
      } else {
        // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Å–∫—Ä—ã–≤–∞–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É
        $carePanel.style.display = 'none';
      }
    } else {
      // –í —Ä–∞–∑–¥–µ–ª–µ home —Å–∫—Ä—ã–≤–∞–µ–º –≤–µ–∑–¥–µ
      $carePanel.style.display = 'none';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ (—Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ)
    if(showInNessffo && !isMobile && $careBtn && !$careBtn.hasAttribute('data-click-added')){
      $careBtn.setAttribute('data-click-added', 'true');
      $careBtn.addEventListener('click', function() {
        $carePanel.style.display = $carePanel.style.display === 'none' ? 'block' : 'none';
        $carePanel.classList.remove('collapsed');
      });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∫–∏
    if(showInNessffo && !$carePanel.hasAttribute('data-click-added')){
      $carePanel.setAttribute('data-click-added', 'true');
      $carePanel.addEventListener('click', function(e) {
        // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–ª–∏ —Å–∞–º—É –ø–∞–Ω–µ–ª—å, –Ω–æ –Ω–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞
        if(e.target.tagName === 'H4' || e.target.closest('h4') || (e.target === this && !e.target.closest('ul')) ){
          $carePanel.classList.toggle('collapsed');
        }
      });
    }
  }
  
  renderCollection(arr, instant);
  // –ø–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ç–∫—É (–µ—Å–ª–∏ –¥–æ —ç—Ç–æ–≥–æ –±—ã–ª —Å–∫–µ–ª–µ—Ç–æ–Ω)
  $catalog.style.display = 'grid';
  // –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º visibility –∏ opacity, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ instant —Ä–µ–Ω–¥–µ—Ä
  if(instant) {
    $catalog.style.visibility = 'visible';
    $catalog.style.opacity = '1';
  }
  // –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
  setHero(currentTab);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
(function tabs(){
  const tabs=document.querySelectorAll('.topnav .tab');
  const filterBtns = document.querySelectorAll('#filters .fbtn');
  const filterByTab = { home: 'all', nessffo: 'all' }; // –¥–µ—Ñ–æ–ª—Ç –Ω–∞ –≤–∫–ª–∞–¥–∫—É

  function setFilter(f){
    console.log('setFilter –≤—ã–∑–≤–∞–Ω–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º:', f);
    activeFilter=f;
    filterByTab[currentTab]=f;
    filterBtns.forEach(b=>b.classList.toggle('active', b.dataset.filter===f));
    console.log('–§–∏–ª—å—Ç—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', activeFilter);
  }

  function activate(tab){
    console.log('activate –≤—ã–∑–≤–∞–Ω–∞ —Å –≤–∫–ª–∞–¥–∫–æ–π:', tab);
    tabs.forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
    console.log('–í–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞:', tab);
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      console.log('–ö–ª–∏–∫ –ø–æ –≤–∫–ª–∞–¥–∫–µ:', tab.dataset.tab);
      if(tab.classList.contains('active')) {
        console.log('–í–∫–ª–∞–¥–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
        return;
      }
      currentTab = tab.dataset.tab;
      console.log('–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É:', currentTab);
      activate(currentTab);
      setFilter(filterByTab[currentTab]);
      renderActive(true);
    });
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      console.log('–ö–ª–∏–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É:', btn.dataset.filter);
      if(btn.classList.contains('active')) {
        console.log('–§–∏–ª—å—Ç—Ä —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
        return;
      }
      setFilter(btn.dataset.filter);
      renderActive(true);
    });
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  activate(currentTab);
  setFilter(filterByTab[currentTab]);
  console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –≤–∫–ª–∞–¥–∫–∞=', currentTab, '—Ñ–∏–ª—å—Ç—Ä=', filterByTab[currentTab]);
  renderActive(true);
})();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, —Ç–æ–≤–∞—Ä–æ–≤ –≤ –º–∞—Å—Å–∏–≤–µ:', items.length);
  console.log('–ö–∞—Ç–∞–ª–æ–≥ –Ω–∞–π–¥–µ–Ω:', !!$catalog);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  console.log('fullscreenViewer –Ω–∞–π–¥–µ–Ω:', !!document.getElementById('fullscreenViewer'));
  console.log('fullscreenTitle –Ω–∞–π–¥–µ–Ω:', !!document.getElementById('fullscreenTitle'));
  console.log('fullscreenImg –Ω–∞–π–¥–µ–Ω:', !!document.getElementById('fullscreenImg'));
  
  if($catalog) {
    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...');
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥
    $catalog.style.display = 'grid';
    $catalog.style.visibility = 'visible';
    $catalog.style.opacity = '1';

    

    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º —Ä–µ–Ω–¥–µ—Ä
    console.log('–í—ã–∑–æ–≤ renderActive...');
    renderActive(true);
    console.log('–ö–∞—Ç–∞–ª–æ–≥ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞:', $catalog.innerHTML.length, '—Å–∏–º–≤–æ–ª–æ–≤');
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
    setTimeout(() => {
      if($catalog.innerHTML.length === 0) {
        console.error('–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç–æ–π –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞!');
        console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º...');
        renderActive(true);
      }
    }, 1000);
  } else {
    console.error('–ö–∞—Ç–∞–ª–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
  }
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', function() {
  console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
  if($catalog && $catalog.innerHTML.length === 0) {
    console.log('–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç–æ–π, –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º...');
    renderActive(true);
  }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–æ: Thu Aug 14 00:24:51 MSK 2025

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function setFullscreenMain(src, animate = false) {
  const fullscreenImg = document.getElementById('fullscreenImg');
  if (!fullscreenImg) {
    console.log('–≠–ª–µ–º–µ–Ω—Ç fullscreenImg –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:', src, '–∞–Ω–∏–º–∞—Ü–∏—è:', animate, 'curIndex:', curIndex);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ src –Ω–µ –ø—É—Å—Ç–æ–π
  if (!src) {
    console.error('–ü—É—Å—Ç–æ–π –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é');
    return;
  }
  
  setSrcWithFallback(fullscreenImg, src, currentHints);
  fullscreenImg.alt = '';
  
  // –§–æ—Ç–æ –æ—Ç —Å–∞–º–æ–≥–æ –≤–µ—Ä—Ö–∞ —ç–∫—Ä–∞–Ω–∞ –±–µ–∑ —á–µ—Ä–Ω–æ–≥–æ
  fullscreenImg.style.objectFit = 'cover';
  fullscreenImg.style.objectPosition = 'center top';
  
  if (animate) {
    // –ü—Ä–æ—Å—Ç–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
    fullscreenImg.style.transition = 'none';
    fullscreenImg.style.opacity = '1';
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  fullscreenImg.onload = () => {
    console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', src);
  };
  
  fullscreenImg.onerror = () => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', src);
  };
}

function renderFullscreenDots(images) {
  const dotsContainer = document.getElementById('fullscreenDots');
  if (!dotsContainer) {
    console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–æ—á–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  dotsContainer.innerHTML = '';
  
  // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ
  if (images && images.length > 1) {
    console.log('–°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏ –¥–ª—è', images.length, '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
    
    images.forEach((imagePath, idx) => {
      const dot = document.createElement('button');
      dot.className = `fullscreen-dot ${idx === curIndex ? 'active' : ''}`;
      dot.setAttribute('data-index', idx);
      dot.setAttribute('aria-label', `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${idx + 1} –∏–∑ ${images.length}`);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
      dot.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('–ö–ª–∏–∫ –ø–æ —Ç–æ—á–∫–µ:', idx, '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:', imagePath);
        
        if (curIndex !== idx) {
          curIndex = idx;
          setFullscreenMain(imagePath, true);
          updateFullscreenDots();
        }
      });
      
      dotsContainer.appendChild(dot);
    });
    
    console.log('–°–æ–∑–¥–∞–Ω–æ —Ç–æ—á–µ–∫:', images.length, '–¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', images);
  } else {
    console.log('–¢–æ—á–∫–∏ –Ω–µ –Ω—É–∂–Ω—ã - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', images ? images.length : 0);
  }
}

function updateFullscreenDots() {
  const dots = document.querySelectorAll('.fullscreen-dot');
  if (!dots.length) {
    console.log('–¢–æ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
    return;
  }
  
  console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏, —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å:', curIndex, '–≤—Å–µ–≥–æ —Ç–æ—á–µ–∫:', dots.length);
  
  dots.forEach((dot, idx) => {
    const dataIndex = parseInt(dot.getAttribute('data-index'));
    
    if (dataIndex === curIndex) {
      dot.classList.add('active');
      console.log('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —Ç–æ—á–∫–∞:', dataIndex);
    } else {
      dot.classList.remove('active');
    }
  });
  
  console.log('–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–æ—á–∫–∏, –∞–∫—Ç–∏–≤–Ω–∞—è:', curIndex, '–≤—Å–µ–≥–æ —Ç–æ—á–µ–∫:', dots.length);
}

function updateModalDots() {
  const dots = document.querySelectorAll('.image-dot');
  if (!dots.length) {
    console.log('–¢–æ—á–∫–∏ –º–æ–¥–∞–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
    return;
  }
  
  console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –º–æ–¥–∞–ª–∫–∏, —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å:', curIndex, '–≤—Å–µ–≥–æ —Ç–æ—á–µ–∫:', dots.length);
  
  dots.forEach((dot, idx) => {
    if (idx === curIndex) {
      dot.classList.add('active');
      console.log('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —Ç–æ—á–∫–∞ –º–æ–¥–∞–ª–∫–∏:', idx);
    } else {
      dot.classList.remove('active');
    }
  });
  
  console.log('–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–æ—á–∫–∏ –º–æ–¥–∞–ª–∫–∏, –∞–∫—Ç–∏–≤–Ω–∞—è:', curIndex, '–≤—Å–µ–≥–æ —Ç–æ—á–µ–∫:', dots.length);
}

function addFullscreenHandlers() {
  const fullscreenImg = document.getElementById('fullscreenImg');
  const fullscreenViewer = document.getElementById('fullscreenViewer');
  const fullscreenCloseBtn = document.getElementById('fullscreenCloseBtn');
  const fullscreenExpandBtn = document.getElementById('fullscreenExpandBtn');
  
  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
  if (fullscreenImg) {
    fullscreenImg.removeEventListener('click', fullscreenImgClickHandler);
    fullscreenImg.addEventListener('click', fullscreenImgClickHandler);
  }
  
  if (fullscreenCloseBtn) {
    fullscreenCloseBtn.removeEventListener('click', closeFullscreenViewer);
    fullscreenCloseBtn.addEventListener('click', closeFullscreenViewer);
  }
  
  if (fullscreenExpandBtn) {
    fullscreenExpandBtn.removeEventListener('click', toggleFullscreenImage);
    fullscreenExpandBtn.addEventListener('click', toggleFullscreenImage);
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Ñ–æ–Ω—É –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
  if (fullscreenViewer) {
    fullscreenViewer.removeEventListener('click', fullscreenViewerClickHandler);
    fullscreenViewer.addEventListener('click', fullscreenViewerClickHandler);
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–≤–∞–π–ø–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  if (fullscreenViewer) {
    fullscreenViewer.removeEventListener('touchstart', fullscreenTouchStartHandler);
    fullscreenViewer.removeEventListener('touchend', fullscreenTouchEndHandler);
    fullscreenViewer.addEventListener('touchstart', fullscreenTouchStartHandler, { passive: true });
    fullscreenViewer.addEventListener('touchend', fullscreenTouchEndHandler, { passive: true });
  }
}

// –í—ã–Ω–æ—Å–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
function fullscreenImgClickHandler(e) {
  const rect = e.target.getBoundingClientRect();
  const left = (e.clientX - rect.left) < rect.width / 2;
  curIndex = (curIndex + (left ? -1 : 1) + current.images.length) % current.images.length;
  setFullscreenMain(current.images[curIndex], true);
  updateFullscreenDots();
}

function fullscreenViewerClickHandler(e) {
  if (e.target === e.currentTarget) {
    closeFullscreenViewer();
  }
}

function fullscreenTouchStartHandler(e) {
  if (e.touches.length === 1) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }
}

function fullscreenTouchEndHandler(e) {
  if (e.changedTouches.length === 1 && current && current.images.length > 1) {
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    
    const deltaX = touchStartX - touchEndX;
    const deltaY = touchStartY - touchEndY;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø
    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
      if (deltaX > 0) {
        // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - —Å–ª–µ–¥—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        curIndex = (curIndex + 1) % current.images.length;
      } else {
        // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        curIndex = (curIndex - 1 + current.images.length) % current.images.length;
      }
      setFullscreenMain(current.images[curIndex], true);
      updateFullscreenDots();
    }
  }
}

function closeFullscreenViewer() {
  const fullscreenViewer = document.getElementById('fullscreenViewer');
  const fullscreenImg = document.getElementById('fullscreenImg');
  const fullscreenExpandBtn = document.getElementById('fullscreenExpandBtn');
  
  if (fullscreenViewer) {
    fullscreenViewer.classList.remove('open');
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    fullscreenViewer.classList.remove('expanded');
    document.body.style.overflow = '';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –∫–Ω–æ–ø–∫–∏
    if (fullscreenExpandBtn) {
      fullscreenExpandBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
      `;
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if (fullscreenImg) {
      fullscreenImg.style.objectFit = 'cover';
      fullscreenImg.style.objectPosition = 'center top';
    }
  }
}

function toggleFullscreenImage() {
  const fullscreenImg = document.getElementById('fullscreenImg');
  const fullscreenViewer = document.getElementById('fullscreenViewer');
  const fullscreenExpandBtn = document.getElementById('fullscreenExpandBtn');
  
  if (!fullscreenImg || !fullscreenViewer) {
    console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
    return;
  }
  
  const isExpanded = fullscreenViewer.classList.contains('expanded');
  console.log('toggleFullscreenImage, isExpanded:', isExpanded);
  
  if (isExpanded) {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –æ–±—ã—á–Ω–æ–º—É —Ä–µ–∂–∏–º—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    fullscreenViewer.classList.remove('expanded');
    fullscreenImg.style.objectFit = 'cover';
    fullscreenImg.style.objectPosition = 'center top';
    fullscreenExpandBtn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
      </svg>
    `;
    console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω –≤ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–∫–∞–∑–∞–Ω');
  } else {
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º - —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    fullscreenViewer.classList.add('expanded');
    fullscreenImg.style.objectFit = 'cover';
    fullscreenImg.style.objectPosition = 'center top';
    fullscreenExpandBtn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 14h6v6M20 10h-6V4M14 10l7-7M3 21l7-7"/>
      </svg>
    `;
    console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–∫—Ä—ã—Ç');
  }
}

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function testFullscreen() {
  console.log('–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä...');
  const testItem = {
    title: '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä',
    price: '1000 —Ä.',
    desc: '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞',
    meta: '–°–æ—Å—Ç–∞–≤: 100% —Ö–ª–æ–ø–æ–∫',
    link: 'https://t.me/stub123',
    status: 'stock',
    images: ['product_1/product_1_1.jpg', 'product_1/product_1_2.jpg']
  };
  openFullscreenViewer(testItem, 'home');
}
